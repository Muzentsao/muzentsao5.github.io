<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>æœ¨äººè‰¸xæ­£é¤é¤ç›’å ±åƒ¹å–®</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root { 
  --primary: #FF8C42; /* ä¸»è‰²ï¼šæ¸©æš–æ©™ï¼ˆé€‚é…é¤é¥®ï¼‰ */
  --primary-light: #FFF0E6; /* ä¸»è‰²æµ…ç‰ˆï¼ˆèƒŒæ™¯ç”¨ï¼‰ */
  --secondary: #4CAF50; /* è¾…åŠ©è‰²ï¼šæ¸…æ–°ç»¿ï¼ˆé‡‘é¢/ç¡®è®¤ç”¨ï¼‰ */
  --tertiary: #E3F2FD; /* è¾…åŠ©è‰²ï¼šæµ…è“ï¼ˆè¡¨å•ç„¦ç‚¹ç”¨ï¼‰ */
  --ink: #2D3748; /* æ­£æ–‡è‰²ï¼šæ·±ç°ï¼ˆæ›´æ˜“è¯»ï¼‰ */
  --muted: #718096; /* è¾…åŠ©æ–‡å­—ï¼šä¸­ç° */
  --light-gray: #F7FAFC; /* èƒŒæ™¯è‰²ï¼šææµ…ç° */
  --line: #E2E8F0; /* è¾¹æ¡†è‰²ï¼šæµ…ç° */
  --danger: #E53E3E; /* å±é™©è‰²ï¼šçº¢è‰²ï¼ˆåˆ é™¤ç”¨ï¼‰ */
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
  --shadow: 0 4px 12px rgba(0,0,0,0.08);
  --radius: 16px; /* ç»Ÿä¸€åœ†è§’ï¼ˆæ›´ç°ä»£ï¼‰ */
  --radius-sm: 12px; /* å°å…ƒç´ åœ†è§’ */
  --transition: all 0.2s ease; /* ç»Ÿä¸€è¿‡æ¸¡åŠ¨ç”» */
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "Segoe UI", Roboto, Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; 
  background: var(--light-gray); 
  color: var(--ink);
  line-height: 1.5;
}

.container { 
  max-width: 1200px; 
  margin: 32px auto; 
  background: #fff; 
  border-radius: var(--radius); 
  box-shadow: var(--shadow); 
  overflow: hidden; 
  border: 1px solid var(--line);
}  

header { 
  padding: 24px 32px; 
  border-bottom: 1px solid var(--line); 
  display: flex; 
  gap: 24px; 
  align-items: center; 
  justify-content: space-between; 
  flex-wrap: wrap; 
  background-color: var(--primary-light);
}

h1 { 
  font-size: 24px; 
  color: var(--primary); 
  font-weight: 700;
}

.muted { 
  color: var(--muted); 
  font-size: 14px; 
  margin-top: 4px;
}

/* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
.toolbar button, #btn-add { 
  padding: 12px 20px; 
  border: none; 
  border-radius: var(--radius-sm); 
  background: var(--primary); 
  color: #fff; 
  cursor: pointer; 
  font-weight: 600;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.toolbar button::before { content: "ğŸ“¥"; }
#btn-add::before { content: "â•"; }

.toolbar button:hover, #btn-add:hover { 
  background: #E07B39; /* ä¸»è‰²åŠ æ·± */
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.toolbar button:active, #btn-add:active { transform: translateY(0); }

main { padding: 28px 32px; }

/* è¡¨å•åŒºå—æ ·å¼ */
.block { 
  border: 1px solid var(--line); 
  border-radius: var(--radius); 
  padding: 20px; 
  background-color: #fff;
  box-shadow: var(--shadow-sm);
  margin-bottom: 20px;
}

/* ç½‘æ ¼å¸ƒå±€ä¼˜åŒ– */
.grid { 
  display: grid; 
  gap: 20px; 
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
}

.row { 
  display: grid; 
  gap: 20px; 
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
  align-items: end; 
  margin-top: 12px;
}

label { 
  display: block; 
  font-size: 14px; 
  color: var(--muted); 
  margin-bottom: 6px;
  font-weight: 500;
}

/* è¾“å…¥æ¡†/ä¸‹æ‹‰æ¡†æ ·å¼ä¼˜åŒ– */
input[type="text"], input[type="date"], input[type="number"], textarea, select { 
  width: 100%; 
  padding: 12px 16px; 
  border: 1px solid var(--line); 
  border-radius: var(--radius-sm); 
  font-size: 16px; 
  height: 48px; 
  transition: var(--transition);
  color: var(--ink);
}

input:focus, select:focus, textarea:focus { 
  outline: none; 
  border-color: var(--primary); 
  box-shadow: 0 0 0 3px var(--tertiary); 
}

/* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
table { 
  width: 100%; 
  border-collapse: separate; 
  border-spacing: 0; 
  margin-top: 16px; 
  border: 1px solid var(--line); 
  border-radius: var(--radius-sm); 
  overflow: hidden;
}

th, td { 
  border-bottom: 1px solid var(--line); 
  border-right: 1px solid var(--line); 
  padding: 12px 16px; 
  text-align: left; 
  vertical-align: middle;
}

th:last-child, td:last-child { border-right: none; }
tr:last-child td { border-bottom: none; }

thead th { 
  background: var(--light-gray); 
  color: var(--ink); 
  font-weight: 600; 
  font-size: 14px; 
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* è¡¨æ ¼è¡Œäº¤äº’ */
tbody tr:hover { background-color: var(--primary-light); transition: var(--transition); }

.right { text-align: right; color: var(--secondary); font-weight: 500; }

.note { 
  margin-top: 12px; 
  color: var(--muted); 
  font-size: 13px; 
  line-height: 1.4;
  padding-left: 20px;
  position: relative;
}

.note::before { 
  content: "â„¹ï¸"; 
  position: absolute; 
  left: 0; 
  top: 0;
}

/* åˆ†ç»„æ ‡é¢˜æ ·å¼ï¼ˆæ¥æºèœå•ï¼‰ */
.group-header td { 
  background: var(--primary-light); 
  font-weight: 700; 
  font-size: 15px; 
  padding: 12px 16px; 
  color: var(--primary); 
  border-width: 1px 0; 
  border-color: var(--line); 
}

/* ç»†èŠ‚ä¼˜åŒ–ï¼šåˆ é™¤æŒ‰é’® */
.btn-del { 
  padding: 6px 12px; 
  border: 1px solid var(--danger); 
  border-radius: var(--radius-sm); 
  background: #fff; 
  color: var(--danger); 
  cursor: pointer; 
  transition: var(--transition);
  font-size: 14px;
}

.btn-del:hover { 
  background: var(--danger); 
  color: #fff; 
}

/* æ€»ä»·åŒºåŸŸæ ·å¼ */
#subtotal, #grand { font-size: 18px; font-weight: 700; }
#grand { color: var(--primary); font-size: 20px; }

/* æ¥æºèœå•æŠ˜å é¢æ¿ */
details { 
  margin-top: 20px; 
  border-radius: var(--radius); 
  border: 1px solid var(--line); 
  overflow: hidden;
}

summary { 
  padding: 16px 20px; 
  background: var(--light-gray); 
  cursor: pointer; 
  list-style: none; 
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

summary::after { content: "â–¼"; font-size: 14px; transition: var(--transition); }
details[open] summary::after { transform: rotate(180deg); }

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
  header { padding: 16px 20px; gap: 16px; }
  h1 { font-size: 20px; }
  main { padding: 20px 16px; }
  .grid, .row { gap: 16px; }
  .block { padding: 16px; }
  th, td { padding: 10px 12px; }
  .toolbar button, #btn-add { padding: 10px 16px; font-size: 14px; }
}

@media print { 
  .toolbar, .btn-row, details { display: none !important; } 
  .container { margin: 0; border: none; border-radius: 0; box-shadow: none; } 
  header { background: #fff; border-bottom: none; }
  h1 { color: var(--ink); }
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>æœ¨äººè‰¸xæ­£é¤é¤ç›’å ±åƒ¹å–®</h1>
      </div>
      <div class="toolbar">
        <button onclick="generateExcel()">ä¸‹è¼‰ Excel (.xlsx)</button>
      </div>
    </header>

    <main>
      <!-- åŸºæœ¬è³‡è¨Š -->
      <section class="grid">
        <div class="block">
          <label>å®¢æˆ¶åç¨±</label>
          <input id="client" type="text" placeholder="è«‹è¼¸å…¥å®¢æˆ¶åç¨±">
        </div>
        <div class="block">
          <label>å ±åƒ¹æ—¥æœŸ</label>
          <input id="date" type="date">
        </div>
      </section>

      <!-- å±¤ç´šä¸‹æ‹‰ï¼ˆé¸å“ï¼‰ -->
      <section class="block" style="margin-top:12px">
        <label style="font-weight:600;color:#374151">å¿«é€Ÿé¸å“ï¼ˆå±¤ç´šä¸‹æ‹‰ï¼‰</label>
        <div class="row">
          <div>
            <label>ä¾¿ç•¶ç¨®é¡ï¼ˆé¤ç›’é¡åˆ¥ï¼‰</label>
            <select id="sel-category"><option value="" disabled selected>è«‹é¸æ“‡ä¾¿ç•¶ç¨®é¡</option></select>
          </div>
          <div>
            <label>é¤ç›’ç¨®é¡</label>
            <select id="sel-item" disabled><option value="" disabled selected>è«‹å…ˆé¸ä¾¿ç•¶ç¨®é¡</option></select>
          </div>
          <div>
            <label>å–®åƒ¹ï¼ˆè‡ª Excel è‡ªå‹•å¸¶å…¥ï¼‰</label>
            <input id="sel-price" type="number" min="0" step="1" value="0" readonly>
          </div>
          <div>
            <label>æ•¸é‡</label>
            <input id="sel-qty" type="number" min="1" step="1" value="1">
          </div>
          <div>
            <button id="btn-add" style="width:100%">åŠ å…¥æ˜ç´°</button>
          </div>
        </div>
      </section>

      <!-- å·²é¸æ˜ç´° -->
      <section class="block" style="margin-top:12px">
        <label style="font-weight:600;color:#374151">è¨‚å–®æ˜ç´°</label>
        <table id="order-table">
          <thead>
            <tr>
              <th>é …ç›®åç¨±ï¼ˆä¸»èœï¼‰èˆ‡å…§å®¹</th>
              <th class="right" style="width:120px">å–®åƒ¹</th>
              <th class="right" style="width:100px">æ•¸é‡</th>
              <th class="right" style="width:140px">å°è¨ˆ</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody id="order-tbody"></tbody>
        </table>
        <div class="grid" style="margin-top:10px; grid-template-columns: 1fr 280px; align-items:start">
          <div class="note">é‡‘é¡åƒ…ä¾›è©¦ç®—ï¼Œå¯¦éš›ä»¥åˆç´„æˆ–æœ€çµ‚å ±åƒ¹ç‚ºæº–ã€‚</div>
          <div>
            <div style="display:grid; gap:6px; justify-content:end">
              <div style="display:grid; grid-template-columns: 1fr 140px; gap:8px"><div>å°è¨ˆ</div><div class="right" id="subtotal">0</div></div>
              <div style="display:grid; grid-template-columns: 1fr 140px; gap:8px; font-weight:700"><div>ç¸½è¨ˆ</div><div class="right" id="grand">0</div></div>
            </div>
          </div>
        </div>
      </section>

  
    </main>
  </div>

<script>
  // åƒ¹æ ¼æ˜ å°„ï¼ˆç”± Excel è§£æå¾—å‡ºï¼›åªå°ã€Œå®Œå…¨ç›¸åŒå“åã€è‡ªå‹•å¸¶å…¥ï¼‰
  const PRICE_MAP = { sheets: {}, flat: {} };
  PRICE_MAP.flat = {
  /* --- äºŒæ ¼ç›’ --- */
  "ç¨å®¶é¦™æ–™é¹¹è±¬è‚‰": 200,
  "æ—¥å¼é¹½éº´è±¬äº”èŠ±": 200,
  "æ—¥å¼é¹½éº´é›è…¿æ’": 200,
  "è”¥æ²¹é›èƒ¸è‚‰": 180,
  "æ³•å¼æ²¹å°æé®‘è‡(å…¨ç´ )": 180,

  /* --- æ¤çº–å››æ ¼ç›’ --- */
  "è‡ªè£½è”¥æ²¹é›èƒ¸è‚‰ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)": 300,
  "æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)": 320,   // â† èª¿æ•´
  "è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)": 320,       // â† èª¿æ•´
  "é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)": 320,
  "ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)": 420,
  "æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)": 320,
  "æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)": 320,

  /* --- éŸ“å¼å…«æ ¼ç›’ --- */
  "éŸ“å¼ç‚¸é› + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)": 280,           // â† èª¿æ•´
  "æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)": 280,       // â† èª¿æ•´
  "ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)": 380,
  "æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)": 280,       // â† èª¿æ•´
  "è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)": 280,         // â† èª¿æ•´
  "é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)": 280,           // â† èª¿æ•´
  "æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)": 280        // â† èª¿æ•´
};

  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const money = n => new Intl.NumberFormat('zh-Hant', { maximumFractionDigits: 0 }).format(n||0);

  /* =========================================================
     1) ç›´æ¥ç”¨å¸¸æ•¸å®šç¾© Catalogï¼ˆå·²ç§»é™¤ä¾†æºèœå–® UIï¼‰
     ========================================================= */
  const catalog = [
    // ğŸ± äºŒæ ¼ç›’
    { id:'b2-1', groupRaw:'ğŸ± äºŒæ ¼ç›’ (é›™æ ¼ç›’ $180-200)', category:'äºŒæ ¼ç›’', name:'ç¨å®¶é¦™æ–™é¹¹è±¬è‚‰', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-2', groupRaw:'ğŸ± äºŒæ ¼ç›’ (é›™æ ¼ç›’ $180-200)', category:'äºŒæ ¼ç›’', name:'æ—¥å¼é¹½éº´è±¬äº”èŠ±', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-3', groupRaw:'ğŸ± äºŒæ ¼ç›’ (é›™æ ¼ç›’ $180-200)', category:'äºŒæ ¼ç›’', name:'æ—¥å¼é¹½éº´é›è…¿æ’', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-4', groupRaw:'ğŸ± äºŒæ ¼ç›’ (é›™æ ¼ç›’ $180-200)', category:'äºŒæ ¼ç›’', name:'è”¥æ²¹é›èƒ¸è‚‰', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-5', groupRaw:'ğŸ± äºŒæ ¼ç›’ (é›™æ ¼ç›’ $180-200)', category:'äºŒæ ¼ç›’', name:'æ³•å¼æ²¹å°æé®‘è‡(å…¨ç´ )', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½æ²¹é†‹é†¬(å…¨ç´ )','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹(è›‹å¥¶ç´ )','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯(å…¨ç´ )'] },

    // ğŸ± æ¤çº–å››æ ¼ç›’ (ç´…è—œç§ˆç±³é£¯çµ„åˆ)
    { id:'p4-1', groupRaw:'ğŸ± æ¤çº–å››æ ¼ç›’ (ç´…è—œç§ˆç±³é£¯çµ„åˆ)', category:'æ¤çº–å››æ ¼ç›’', name:'è‡ªè£½è”¥æ²¹é›èƒ¸è‚‰ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-2', groupRaw:'ğŸ± æ¤çº–å››æ ¼ç›’ (ç´…è—œç§ˆç±³é£¯çµ„åˆ)', category:'æ¤çº–å››æ ¼ç›’', name:'æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-3', groupRaw:'ğŸ± æ¤çº–å››æ ¼ç›’ (ç´…è—œç§ˆç±³é£¯çµ„åˆ)', category:'æ¤çº–å››æ ¼ç›’', name:'è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-4', groupRaw:'ğŸ± æ¤çº–å››æ ¼ç›’ (ç´…è—œç§ˆç±³é£¯çµ„åˆ)', category:'æ¤çº–å››æ ¼ç›’', name:'é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-5', groupRaw:'ğŸ± æ¤çº–å››æ ¼ç›’ (ç´…è—œç§ˆç±³é£¯çµ„åˆ)', category:'æ¤çº–å››æ ¼ç›’', name:'ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-6', groupRaw:'ğŸ± æ¤çº–å››æ ¼ç›’ (ç´…è—œç§ˆç±³é£¯çµ„åˆ)', category:'æ¤çº–å››æ ¼ç›’', name:'æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-7', groupRaw:'ğŸ± æ¤çº–å››æ ¼ç›’ (ç´…è—œç§ˆç±³é£¯çµ„åˆ)', category:'æ¤çº–å››æ ¼ç›’', name:'æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },

    // ğŸ± éŸ“å¼å…«æ ¼ç›’
    { id:'k8-1', groupRaw:'ğŸ± éŸ“å¼å…«æ ¼ç›’', category:'éŸ“å¼å…«æ ¼ç›’', name:'éŸ“å¼ç‚¸é› + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-2', groupRaw:'ğŸ± éŸ“å¼å…«æ ¼ç›’', category:'éŸ“å¼å…«æ ¼ç›’', name:'æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-3', groupRaw:'ğŸ± éŸ“å¼å…«æ ¼ç›’', category:'éŸ“å¼å…«æ ¼ç›’', name:'ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-4', groupRaw:'ğŸ± éŸ“å¼å…«æ ¼ç›’', category:'éŸ“å¼å…«æ ¼ç›’', name:'æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-5', groupRaw:'ğŸ± éŸ“å¼å…«æ ¼ç›’', category:'éŸ“å¼å…«æ ¼ç›’', name:'è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-6', groupRaw:'ğŸ± éŸ“å¼å…«æ ¼ç›’', category:'éŸ“å¼å…«æ ¼ç›’', name:'é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-7', groupRaw:'ğŸ± éŸ“å¼å…«æ ¼ç›’', category:'éŸ“å¼å…«æ ¼ç›’', name:'æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
  ];

  /* =========================================================
     2) åˆå§‹åŒ–å±¤ç´šä¸‹æ‹‰ï¼ˆä¾¿ç•¶ç¨®é¡ â†’ é¤ç›’ç¨®é¡ï¼‰
     ========================================================= */
  const selCategory = $('#sel-category');
  const selItem = $('#sel-item');
  const selPrice = $('#sel-price');
  const selQty = $('#sel-qty');
  const orderTbody = $('#order-tbody');

  const preferredOrder = ['äºŒæ ¼ç›’', 'æ¤çº–å››æ ¼ç›’', 'éŸ“å¼å…«æ ¼ç›’'];
  const categories = [...new Set(catalog.map(x => x.category))];
  categories.sort((a,b)=>{
    const ia = preferredOrder.indexOf(a), ib = preferredOrder.indexOf(b);
    if (ia !== -1 && ib !== -1) return ia - ib;
    if (ia !== -1) return -1;
    if (ib !== -1) return 1;
    return a.localeCompare(b,'zh-Hant');
  });
  categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    selCategory.appendChild(opt);
  });

  // é¸æ“‡ä¾¿ç•¶ç¨®é¡ â†’ è¼‰å…¥å°æ‡‰é¤ç›’é¸é …
  selCategory.addEventListener('change', () => {
    selItem.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç¨®é¡</option>';
    selItem.disabled = !selCategory.value;
    if (selCategory.value) {
      catalog.filter(x => x.category === selCategory.value).forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.id;
        opt.textContent = item.name;
        selItem.appendChild(opt);
      });
      selItem.focus();
    }
  });

  function getAutoPriceByName(name){
    if (PRICE_MAP && PRICE_MAP.flat && Object.prototype.hasOwnProperty.call(PRICE_MAP.flat, name)) {
      return PRICE_MAP.flat[name];
    }
    return null;
  }

  // æè¿°çµ„è£ï¼ˆå¤šè¡Œå«é…èœï¼‰
  function buildDesc(item){
    const parts = [item.name];
    if (item.meta) parts.push(item.meta);
    if (item.includes && item.includes.length) {
      parts.push(...item.includes.map(v => `  - ${v}`));
    }
    return parts.join('\n');
  }

  // é¸æ“‡é¤ç›’ â†’ è‡ªå‹•å¸¶å…¥åƒ¹æ ¼ï¼ˆè‹¥æœ‰ï¼‰
  selItem.addEventListener('change', () => {
    const item = catalog.find(x => x.id === selItem.value);
    if (!item) return;
    const p = getAutoPriceByName(item.name);
    selPrice.value = (p != null) ? p : 0;
  });

  /* =========================================================
     3) åŠ å…¥æ˜ç´° + è¨ˆç®—
     ========================================================= */
  function recalc(){
    let subtotal = 0;
    $$('#order-tbody tr').forEach(tr => {
      const price = Number(tr.dataset.price||0);
      const qty = Number(tr.dataset.qty||0);
      const line = price * qty;
      subtotal += line;
      tr.querySelector('.line-subtotal').textContent = money(line);
    });
    $('#subtotal').textContent = money(subtotal);
    $('#grand').textContent = money(subtotal);
  }

  function addRow({ itemId, price, qty }){
    const item = catalog.find(x => x.id === itemId);
    if (!item) return;
    const desc = buildDesc(item);
    const tr = document.createElement('tr');
    tr.dataset.price = String(price);
    tr.dataset.qty = String(qty);
    tr.dataset.group = item.category;
    tr.dataset.itemId = item.id;
    tr.innerHTML = `
      <td style="white-space:pre-wrap">${desc}</td>
      <td class="right">${money(price)}</td>
      <td class="right">${money(qty)}</td>
      <td class="right line-subtotal">0</td>
      <td class="right"><button type="button" class="btn-del" style="padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff">åˆªé™¤</button></td>
    `;
    tr.querySelector('.btn-del').addEventListener('click', () => {
      if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.name}ã€é€™é …å—ï¼Ÿ`)) {
        tr.remove();
        recalc();
      }
    });
    tr.style.opacity = '0';
    tr.style.transform = 'translateY(10px)';
    orderTbody.appendChild(tr);
    setTimeout(() => {
      tr.style.opacity = '1';
      tr.style.transform = 'translateY(0)';
      tr.style.transition = 'all 0.2s ease';
    }, 10);
    recalc();
  }

  $('#btn-add').addEventListener('click', () => {
    const group = selCategory.value;
    const itemId = selItem.value;
    if (!group) { alert('è«‹å…ˆé¸æ“‡ã€Œä¾¿ç•¶ç¨®é¡ã€'); return; }
    if (!itemId) { alert('è«‹é¸æ“‡ã€Œé¤ç›’ç¨®é¡ã€'); return; }
    const price = Number(selPrice.value||0);
    const qty = Number(selQty.value||1);
    addRow({ itemId, price, qty });
    selQty.value = 1; // é‡ç½®æ•¸é‡
  });

  /* =========================================================
     4) Excel åŒ¯å‡º
     ========================================================= */
  function generateExcel(){
    const client = $('#client').value || 'å®¢æˆ¶';
    const date = $('#date').value;
    const filename = `å ±åƒ¹å–®_${client}_${date||new Date().toISOString().slice(0,10)}.xlsx`;

    const rows = [];
    rows.push(['æ­£é¤é¤ç›’å ±åƒ¹å–®']);
    rows.push([null]);
    rows.push(['å®¢æˆ¶åç¨±', client]);
    rows.push(['å ±åƒ¹æ—¥æœŸ', date]);
    rows.push([null]);
    rows.push(['é …ç›®åç¨±ï¼ˆä¸»èœï¼‰èˆ‡å…§å®¹','å–®åƒ¹','æ•¸é‡','å°è¨ˆ']);

    const items = $$('#order-tbody tr').map(tr => ({
      group: tr.dataset.group,
      desc: tr.children[0].textContent,
      price: Number(tr.dataset.price||0),
      qty: Number(tr.dataset.qty||0),
      subtotal: Number(tr.dataset.price||0) * Number(tr.dataset.qty||0)
    }));

    const byGroup = {};
    items.forEach(it => { (byGroup[it.group] ||= []).push(it); });
    Object.keys(byGroup).forEach(g => {
      rows.push([`--- ${g} ---`, null, null, null]);
      byGroup[g].forEach(it => rows.push([it.desc, it.price, it.qty, it.subtotal]));
    });

    const total = items.reduce((a,b)=>a+b.subtotal,0);
    rows.push([null]);
    rows.push([null,null,'å°è¨ˆ', total]);
    rows.push([null,null,'ç¸½è¨ˆ', total]);

    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [{wch:64},{wch:10},{wch:10},{wch:14}];
    ws['!merges'] = [ { s:{r:0,c:0}, e:{r:0,c:3} } ];

    const headerRows = 6;
    rows.forEach((r, i) => {
      if (i >= headerRows && i < rows.length - 3) {
        const cellA = `A${i+1}`;
        if (r[1] !== null) {
          if (ws[cellA]) ws[cellA].s = { alignment:{ wrapText:true, vertical:'top' } };
        } else {
          ws['!merges'].push({ s:{r:i,c:0}, e:{r:i,c:3} });
          if (ws[cellA]) ws[cellA].s = { font:{bold:true}, alignment:{ horizontal:'center' } };
        }
      }
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'å ±åƒ¹å–®');
    XLSX.writeFile(wb, filename);
  }
  window.generateExcel = generateExcel;

  /* =========================================================
     5) å…¶ä»–åˆå§‹åŒ–
     ========================================================= */
  (function initMeta(){
    const today = new Date();
    $('#date').value = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);
  })();

  // é‡‘é¡è¼¸å…¥é˜²å‘†ï¼šåƒ…æ•¸å­—
  selPrice.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  });

  window.addEventListener('load', () => {
    console.log('ğŸ“‹ å ±åƒ¹å–®é é¢å·²æº–å‚™å°±ç·’ï¼è«‹å…ˆè¼¸å…¥å®¢æˆ¶è³‡è¨Šï¼Œå†é¸æ“‡é¤ç›’ç¨®é¡');
    $('#client').focus();
  });

  /* =========================================================
     6) ç°¡æ˜“è‡ªå‹•åŒ–æ¸¬è©¦ï¼ˆConsoleï¼‰
     ========================================================= */
  (function runTests(){
    try {
      console.assert(Array.isArray(catalog) && catalog.length > 0, 'catalog æ‡‰è©²å»ºç«‹æˆåŠŸ');
      const cats = [...new Set(catalog.map(x=>x.category))];
      console.assert(cats.includes('äºŒæ ¼ç›’') && cats.includes('æ¤çº–å››æ ¼ç›’') && cats.includes('éŸ“å¼å…«æ ¼ç›’'), 'æ‡‰åŒ…å«ä¸‰å¤§é¡åˆ¥');

      console.assert(PRICE_MAP.flat['æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)'] === 320, 'æ‡‰ç‚º 320');
console.assert(PRICE_MAP.flat['è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)'] === 320, 'æ‡‰ç‚º 320');
console.assert(PRICE_MAP.flat['éŸ“å¼ç‚¸é› + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)'] === 280, 'æ‡‰ç‚º 280');
      
      const d = buildDesc({ name:'æ¸¬è©¦ä¸»èœ', meta:'äºŒæ ¼ç›’', includes:['é…èœ: A','é…èœ: B'] });
      console.assert(/\n  - é…èœ: A/.test(d) && /\n  - é…èœ: B/.test(d), 'buildDesc æ‡‰æ­£ç¢ºçµ„è£é…èœ');

      console.assert(getAutoPriceByName('ä¸å­˜åœ¨çš„å“å') == null, 'æœªçŸ¥å“åä¸å¯è‡ªå‹•å®šåƒ¹');

      console.log('%cAll tests passed','color:green');
    } catch (e) {
      console.error('Tests failed', e);
    }
  })();
</script>
</body>
</html>
