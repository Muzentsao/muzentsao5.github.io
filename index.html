<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>æœ¨äººè‰¸xæ­£é¤é¤ç›’å ±åƒ¹å–®</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com"/>
<style>
/* CSS æ¨£å¼ç¶­æŒä¸è®Š */
:root { 
  --primary: #FF8C42; 
  --primary-light: #FFF0E6; 
  --secondary: #4CAF50; 
  --tertiary: #E3F2FD; 
  --ink: #2D3748; 
  --muted: #718096; 
  --light-gray: #F7FAFC; 
  --line: #E2E8F0; 
  --danger: #E53E3E; 
  --warning-bg: #FFF4E5; 
  --warning-text: #663C00; 
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
  --shadow: 0 4px 12px rgba(0,0,0,0.08);
  --radius: 16px; 
  --radius-sm: 12px; 
  --transition: all 0.2s ease; 
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body { 
  font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "Segoe UI", Roboto, Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; 
  background: var(--light-gray); 
  color: var(--ink);
  line-height: 1.5;
}

.container { 
  max-width: 1200px; 
  margin: 0 auto 32px auto; 
  background: #fff; 
  border-radius: var(--radius); 
  box-shadow: var(--shadow); 
  overflow: hidden; 
  border: 1px solid var(--line);
}   

header { 
  padding: 24px 32px; 
  border-bottom: 1px solid var(--line); 
  display: flex; 
  gap: 24px; 
  align-items: center; 
  justify-content: center; 
  flex-wrap: wrap; 
  background-color: var(--primary-light);
}

h1 { font-size: 24px; color: var(--primary); font-weight: 700; margin-bottom: 0; }
.muted { color: var(--muted); font-size: 14px; margin-top: 4px; }

#btn-download, #btn-add { 
  padding: 12px 20px; 
  border: none; 
  border-radius: var(--radius-sm); 
  background: var(--primary); 
  color: #fff; 
  cursor: pointer; 
  font-weight: 600; 
  transition: var(--transition); 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  gap: 8px;
}
#btn-download::before { content: "ğŸ–¨ï¸"; }
#btn-add::before { content: "â•"; }
#btn-download:hover, #btn-add:hover { background: #E07B39; transform: translateY(-2px); box-shadow: var(--shadow-sm); }
#btn-download:active, #btn-add:active { transform: translateY(0); }

#btn-download:disabled {
  background-color: #CBD5E0;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

main { padding: 28px 32px; }

.block { 
  border: 1px solid var(--line); 
  border-radius: var(--radius); 
  padding: 20px; 
  background-color: #fff; 
  box-shadow: var(--shadow-sm); 
  margin-bottom: 20px;
}

.grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
.row { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); align-items: end; margin-top: 12px; }

label { display: block; font-size: 14px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }

input[type="text"], input[type="date"], input[type="number"], input[type="tel"], textarea, select, input[type="time"] { 
  width: 100%; 
  padding: 12px 16px; 
  border: 1px solid var(--line); 
  border-radius: var(--radius-sm); 
  font-size: 16px; 
  height: 48px; 
  transition: var(--transition); 
  color: var(--ink);
  background: #fff; 
}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--tertiary); }

.selection-wrapper {
  display: flex;
  gap: 24px;
  align-items: start;
}
.selection-left { flex: 2; } 
.selection-right { 
  flex: 1; 
  min-width: 250px;
  background: var(--light-gray);
  border-radius: var(--radius);
  border: 1px solid var(--line);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.preview-box {
  flex-grow: 1;
  background: #eee;
  position: relative;
  height: 240px;      
  width: 100%;        
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border-bottom: 1px solid var(--line); 
}
.preview-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none; 
}
.preview-placeholder {
  color: var(--muted);
  font-size: 14px;
  text-align: center;
  line-height: 1.6;
}
.preview-info {
  padding: 16px;
  background: #fff;
  border-top: 1px solid var(--line);
}
.preview-title { font-weight: 700; color: var(--primary); margin-bottom: 4px; font-size: 16px; }
.preview-desc { font-size: 13px; color: var(--muted); line-height: 1.4; }

table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 16px; border: 1px solid var(--line); border-radius: var(--radius-sm); overflow: hidden; }
th, td { border-bottom: 1px solid var(--line); border-right: 1px solid var(--line); padding: 12px 16px; text-align: left; vertical-align: middle; }
th:last-child, td:last-child { border-right: none; }
tr:last-child td { border-bottom: none; }
thead th { background: var(--light-gray); color: var(--ink); font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
tbody tr:hover { background-color: var(--primary-light); transition: var(--transition); }
.right { text-align: right; color: var(--secondary); font-weight: 500; }
.note { margin-top: 12px; color: var(--muted); font-size: 13px; line-height: 1.4; padding-left: 20px; position: relative; }
.note::before { content: "â„¹ï¸"; position: absolute; left: 0; top: 0; }
.btn-del { padding: 6px 12px; border: 1px solid var(--danger); border-radius: var(--radius-sm); background: #fff; color: var(--danger); cursor: pointer; transition: var(--transition); font-size: 14px; }
.btn-del:hover { background: var(--danger); color: #fff; }
#subtotal, #grand { font-size: 18px; font-weight: 700; }
#grand { color: var(--primary); font-size: 20px; }

.input-hint { font-size: 12px; color: var(--danger); margin-top: 4px; display: block; }

.disclaimer {
  margin-top: 12px;
  font-size: 13px;
  color: #718096;
  text-align: center;
  background: #EDF2F7;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #E2E8F0;
}

.modal-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.modal-overlay.active {
  opacity: 1;
  pointer-events: auto;
}
.modal-content {
  background: #fff;
  width: 90%;
  max-width: 400px;
  padding: 32px 24px;
  border-radius: 24px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  transform: translateY(20px);
  transition: transform 0.3s ease;
}
.modal-overlay.active .modal-content {
  transform: translateY(0);
}
.modal-icon {
  font-size: 48px;
  margin-bottom: 16px;
  display: block;
}
.modal-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--ink);
  margin-bottom: 12px;
}
.modal-text {
  font-size: 15px;
  color: var(--muted);
  line-height: 1.6;
  margin-bottom: 24px;
}
.modal-btn {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 12px 32px;
  border-radius: 50px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: background 0.2s;
}
.modal-btn:hover {
  background: #e07b39;
}

.date-time-wrapper {
  display: grid;
  grid-template-columns: 2fr 1fr; 
  gap: 12px;
}

.morning-fee-alert {
  display: none; 
  margin-top: 10px;
  padding: 12px 16px;
  background-color: #FFF4E5; 
  border: 1px solid #FCD34D; 
  border-radius: 8px;
  color: #92400E; 
  font-size: 14px;
  line-height: 1.5;
  animation: fadeIn 0.3s ease-in-out;
}
.morning-fee-alert strong {
  font-weight: 700;
  color: #B45309;
}

.evening-alert {
  display: none; 
  margin-top: 10px;
  padding: 12px 16px;
  background-color: #FEF2F2; 
  border: 1px solid #FECACA; 
  border-radius: 8px;
  color: #991B1B; 
  font-size: 14px;
  line-height: 1.5;
  animation: fadeIn 0.3s ease-in-out;
}
.evening-alert strong {
  font-weight: 700;
  color: #7F1D1D;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

.step-navigation {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  background: #fff;
  border-bottom: 1px solid var(--line);
}
.step-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--muted);
  transition: var(--transition);
}
.step-item.active { color: var(--primary); }
.step-number {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--line);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}
.step-item.active .step-number { background: var(--primary); }
.step-divider {
  width: 40px;
  height: 2px;
  background: var(--line);
  margin: 0 16px;
}

.step-btn-area {
    display: flex;
    justify-content: space-between;
    margin-top: 24px;
}
.btn-next, .btn-prev {
    padding: 12px 32px;
    border-radius: 50px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    font-size: 16px;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-next { background: var(--primary); color: #fff; }
.btn-next:hover { background: #e07b39; }
.btn-prev { background: #EDF2F7; color: var(--ink); border: 1px solid var(--line); }
.btn-prev:hover { background: #E2E8F0; }

@media (max-width: 768px) {
  .hero-section { padding: 3rem 1.5rem !important; text-align: center; }
  .hero-text-area { text-align: center; margin-bottom: 2rem; }
  .hero-btn { width: 100%; text-align: center; }
  header { padding: 16px 20px; gap: 16px; }
  h1 { font-size: 20px; }
  main { padding: 20px 16px; }
  .grid, .row { gap: 16px; }
  .block { padding: 16px; }
  th, td { padding: 10px 12px; }
  #btn-download, #btn-add { padding: 10px 16px; font-size: 14px; }
  .selection-wrapper { flex-direction: column; }
  .selection-right { min-height: 250px; }
  .date-time-wrapper {
    grid-template-columns: 1fr;
    gap: 8px;
  }
}

/* ğŸŸ¢ğŸŸ¢ğŸŸ¢ PDF ç¾åŒ–èˆ‡åˆ—å°æ¨£å¼ ğŸŸ¢ğŸŸ¢ğŸŸ¢ */
@media print {
  body { background: #fff !important; color: #000 !important; }
  .container { max-width: 100% !important; margin: 0 !important; border: none !important; box-shadow: none !important; }
  .hero-section, header, .step-navigation, .step-btn-area, .btn-prev, 
  .selection-wrapper, .btn-del, #btn-download, .input-hint, 
  .disclaimer, .modal-overlay, .morning-fee-alert, .evening-alert { 
    display: none !important; 
  }
  #step-1-wrapper, #step-2-wrapper { display: block !important; visibility: visible !important; }
  .block { border: none !important; box-shadow: none !important; padding: 0 !important; margin-bottom: 20px !important; }
  input, select, textarea { 
    border: none !important; 
    padding: 0 !important; 
    background: transparent !important; 
    font-size: 15px !important;
    height: auto !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    color: #000 !important;
    font-weight: 500 !important;
  }
  .tax-type-radio-container { display: none !important; }
  table { border-collapse: collapse !important; margin-top: 10px !important; border: 1px solid #ddd !important; }
  th { background-color: #f8f9fa !important; color: #333 !important; font-size: 13px !important; border: 1px solid #ddd !important; padding: 10px !important; }
  td { border: 1px solid #ddd !important; padding: 10px !important; font-size: 14px !important; }
  tr { page-break-inside: avoid !important; }
  #grand { font-size: 22px !important; color: #000 !important; text-decoration: none !important; border-bottom: 2px solid #000; }
  .form-header h2 { font-size: 26px !important; margin-bottom: 15px !important; }
  .fee-row { display: grid !important; color: #000 !important; }
  @page { size: A4; margin: 1.5cm; }
}
</style>
</head>
<body>

  <section class="hero-section" style="width:100%; background:#f9f7f4; padding:5rem 2rem; margin-bottom:2rem; position:relative; overflow:hidden;">
    <div style="position:absolute; top:-20%; right:-10%; width:40%; height:40%; background:#e8f4ea; border-radius:50%; opacity:0.6;"></div>
    <div style="position:absolute; bottom:-15%; left:-8%; width:30%; height:30%; background:#f0ebe2; border-radius:50%; opacity:0.6;"></div>
    <div style="max-width:1200px; margin:0 auto; position:relative; z-index:2;">
      <div style="display:flex; flex-wrap:wrap; align-items:center; gap:3rem;">
        <div class="hero-text-area" style="flex:1 1 500px;">
          <h1 style="font-size:2.8rem; color:#2d3748; margin:0 0 1rem 0; line-height:1.3; font-weight:700;">
            æœ¨äººè‰¸xæ­£é¤é¤ç›’<br>
            <span style="color:#FF8C42;">å¥åº·é£²é£Ÿï¼Œç¾å‘³æº–æ™‚ç›´é€ã€‚</span>
          </h1>
          <p style="font-size:1.1rem; color:#4a5568; margin:0 0 1.5rem 0; line-height:1.6; max-width:600px;">
            ç²¾é¸æ–°é®®é£Ÿæï¼Œå¤šç¨®å¥—é¤é¸æ“‡ï¼ˆäºŒæ ¼ç›’/æ¤çº–å››æ ¼ç›’/éŸ“å¼å…«æ ¼ç›’ï¼‰ï¼Œé©åˆä¼æ¥­åœ˜é¤ã€æ´»å‹•ä¾›æ‡‰ã€åœ˜é«”è¨‚è³¼ã€‚
          </p>
          <div style="background: #fff; border-left: 4px solid #E53E3E; padding: 16px; margin-bottom: 2rem; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div style="display:flex; flex-direction:column; gap:8px;">
                <p style="margin:0; color:#E53E3E; font-weight:600; font-size: 1rem;">
                  âš ï¸ å»ºè­°180å…ƒ/äººèµ·è·³
                  <span style="font-size:0.9em; color:#718096; font-weight:400;">(æœªç¨…æœªå«äº¤é€šè²»)</span>
                </p>
                <p style="margin:0; color:#2D3748; font-weight:500; font-size: 0.95rem;">
                  ğŸš› æœå‹™ç¯„åœåƒ…é™é›™åŒ—åœ°å€ <span style="font-size:0.9em; color:#718096; font-weight:400;">(å±±å€åŠåé åœ°å€é™¤å¤–)</span>
                </p>
                <p style="margin:0; color:#2D3748; font-weight:500; font-size: 0.95rem;">
                  â³ éœ€æå‰ 5 å€‹å·¥ä½œå¤©é è¨‚ <span style="font-size:0.9em; color:#718096; font-weight:400;">(ä¸å«ä¾‹å‡æ—¥ï¼Œç¢ºä¿é£Ÿææ–°é®®æº–å‚™)</span>
                </p>
            </div>
          </div>
          <a href="#order-form" class="hero-btn" style="display:inline-block; background:#FF8C42; color:white; padding:1rem 2.5rem; border-radius:50px; font-size:1.1rem; font-weight:600; text-decoration:none; transition:all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);">
            ç«‹å³é¸å“å ±åƒ¹ â–¼
          </a>
        </div>
        <div style="flex:1 1 400px; text-align:center;">
          <img src="Gemini_Generated_Image_t58s2vt58s2vt58s.jpg" alt="æœ¨äººè‰¸æ­£é¤é¤ç›’å±•ç¤º" style="width:100%; max-width:500px; height:auto; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.1); object-fit: cover;">
        </div>
      </div>
    </div>
  </section>

  <div class="container" id="order-form">
    <div class="step-navigation">
        <div class="step-item active" id="step-nav-1">
            <span class="step-number">1</span>
            <span>å¡«å¯«è³‡æ–™</span>
        </div>
        <div class="step-divider"></div>
        <div class="step-item" id="step-nav-2">
            <span class="step-number">2</span>
            <span>é¸æ“‡é¤é»</span>
        </div>
    </div>

    <main>

    <div id="step-1-wrapper">
        <section class="block">
            <div class="form-header">
                <h2 style="color:var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px;">æœ¨äººè‰¸ æ­£é¤é¤ç›’å ±åƒ¹å–®</h2>
                <div class="muted">æˆ‘å€‘éœ€è¦æ­£ç¢ºçš„è³‡è¨Šä»¥ç‚ºæ‚¨æä¾›æ­£å¼å ±åƒ¹</div>
            </div>
            <br>
            <div class="form-grid-container">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>å ±åƒ¹å–®ç·¨è™Ÿ (ç³»çµ±è‡ªå‹•ç”Ÿæˆ)</label>
                    <input id="order-id" type="text" readonly style="background-color: var(--light-gray); color: var(--muted); font-weight: 700; border-style: dashed;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>å®¢æˆ¶åç¨± <span class="required-mark" style="color:var(--danger)">*</span></label>
                    <input id="client" type="text" placeholder="è«‹è¼¸å…¥å…¬å¸æˆ–è¨‚è³¼äººåç¨±">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>ç™¼ç¥¨é–‹ç«‹å°è±¡ <span class="required-mark" style="color:var(--danger)">*</span></label>
                    <div class="tax-type-radio-container" style="display: flex; gap: 20px; margin-bottom: 10px; padding: 10px 0;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--ink); font-size: 15px;">
                            <input type="radio" name="tax-type" value="company" checked style="width: 18px; height: 18px; accent-color: var(--primary);"> å…¬å¸ï¼ˆæœ‰çµ±ç·¨ï¼‰
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--ink); font-size: 15px;">
                            <input type="radio" name="tax-type" value="individual" style="width: 18px; height: 18px; accent-color: var(--primary);"> å€‹äºº/å…¶ä»–ï¼ˆç„¡çµ±ç·¨ï¼‰
                        </label>
                    </div>
                    <label id="tax-id-label">çµ±ä¸€ç·¨è™Ÿ <span class="required-mark" style="color:var(--danger)">*</span></label>
                    <input id="tax-id" type="text" placeholder="è«‹è¼¸å…¥ 8 ä½æ•¸çµ±ä¸€ç·¨è™Ÿ">
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label>è¯çµ¡é›»è©± <span class="required-mark" style="color:var(--danger)">*</span></label>
                    <input id="phone" type="tel" placeholder="ç¯„ä¾‹ï¼š0912345678">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>é è¨ˆé€é”æ—¥æœŸ & æ™‚é–“ <span class="required-mark" style="color:var(--danger)">*</span></label>
                    <div class="date-time-wrapper">
                        <input id="date" type="date">
                        <input id="time" type="time" min="09:00" max="19:00" value="12:00">
                    </div>
                    <small class="input-hint">âš ï¸ éœ€è‡³å°‘æå‰ 5 å€‹å·¥ä½œå¤©é è¨‚ï¼ˆä¸å«å…­æ—¥ï¼‰</small>
                    <div id="morning-fee-alert" class="morning-fee-alert">
                        ğŸ”” <strong>æ—©æ™¨åŠ æˆæé†’ï¼š</strong><br>
                        è‹¥é¤ç›’äº¤é¤æ™‚é–“æ–¼ <strong>æ—©ä¸Š 10:00 ä»¥å‰</strong>ï¼Œå°‡å¦æ”¶å–æ—©æ™¨åŠ æˆè²»ç”¨ <strong>$3,500 å…ƒ</strong> (æœªç¨…)ã€‚
                    </div>
                    <div id="evening-alert" class="evening-alert">
                        â›” <strong>é…é€æ™‚é–“æé†’ï¼š</strong><br>
                        æŠ±æ­‰ï¼Œ<strong>18:00 ä»¥å¾Œ</strong> ç‚ºéè£½ä½œèˆ‡é…é€æ™‚æ®µï¼Œè«‹èª¿æ•´æ‚¨çš„é€é”æ™‚é–“ã€‚
                    </div>
                </div>
                <div class="form-group full" style="margin-bottom: 20px;">
                    <label>é…é€åœ°å€ <span class="required-mark" style="color:var(--danger)">*</span></label>
                    <input id="address" type="text" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€ï¼ˆå«ç¸£å¸‚ï¼‰">
                </div>
            </div>

            <div class="step-btn-area">
                <div></div>
                <button type="button" class="btn-next" onclick="goToStep(2)">ä¸‹ä¸€æ­¥ï¼šé–‹å§‹é¸è³¼é¤é» âœ</button>
            </div>
        </section>
    </div>

    <div id="step-2-wrapper" style="display: none;">
        
        <div style="margin-bottom: 16px;">
            <button type="button" class="btn-prev" onclick="goToStep(1)">â¬… ä¸Šä¸€æ­¥ï¼šä¿®æ”¹è¨‚è³¼è³‡è¨Š</button>
        </div>

        <section class="block">
            <label style="font-weight:600;color:#374151; margin-bottom:12px; display:block">å¿«é€Ÿé¸å“ï¼ˆå±¤ç´šä¸‹æ‹‰ï¼‰</label>
            <div class="selection-wrapper">
                <div class="selection-left">
                    <div class="row" style="margin-top:0">
                        <div style="grid-column: 1 / -1">
                            <label>ä¾¿ç•¶ç¨®é¡ï¼ˆé¤ç›’é¡åˆ¥ï¼‰</label>
                            <select id="sel-category"><option value="" disabled selected>è«‹é¸æ“‡ä¾¿ç•¶ç¨®é¡</option></select>
                        </div>
                        <div style="grid-column: 1 / -1">
                            <label>é¤ç›’ç¨®é¡</label>
                            <select id="sel-item" disabled><option value="" disabled selected>è«‹å…ˆé¸ä¾¿ç•¶ç¨®é¡</option></select>
                        </div>
                        <div>
                            <label>å–®åƒ¹ <span style="font-size:13px; color:#E53E3E;">(æœªç¨…)</span></label>
                            <input id="sel-price" type="number" min="0" step="1" value="0" readonly>
                        </div>
                        <div>
                            <label>æ•¸é‡</label>
                            <input id="sel-qty" type="number" min="1" step="1" value="1">
                        </div>
                        <div style="display:flex; align-items:end;">
                            <button id="btn-add" style="width:100%; height:48px;">åŠ å…¥æ˜ç´°</button>
                        </div>
                    </div>
                </div>
                <div class="selection-right">
                    <div class="preview-box">
                        <div class="preview-placeholder" id="preview-placeholder">
                            è«‹é¸æ“‡å·¦å´é¤é»<br>ä»¥æª¢è¦–åœ–ç‰‡èˆ‡å…§å®¹
                        </div>
                        <img id="preview-img" src="" alt="é¤é»é è¦½">
                    </div>
                    <div class="preview-info">
                        <div class="preview-title" id="preview-title">--</div>
                        <div class="preview-desc" id="preview-desc">é¸æ“‡é¤é»å¾Œå°‡é¡¯ç¤ºè©³ç´°é…èœå…§å®¹</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="block" style="margin-top: 20px;">
            <div class="form-header">
                <h2 style="display:flex; align-items:center; justify-content:space-between;">
                    è¨‚å–®å…§å®¹ç¢ºèª
                </h2>
                <div class="muted">è«‹ç¢ºèªæ‚¨é¸è³¼çš„é¤é»é …ç›®èˆ‡æ•¸é‡</div>
            </div>
            <table id="order-table">
                <thead>
                    <tr>
                        <th style="width:100px">ç¤ºæ„åœ–</th>
                        <th>é …ç›®åç¨±ï¼ˆä¸»èœï¼‰èˆ‡å…§å®¹</th>
                        <th class="right" style="width:100px">å–®åƒ¹</th>
                        <th class="right" style="width:80px">æ•¸é‡</th>
                        <th class="right" style="width:120px">å°è¨ˆ</th>
                        <th style="width:60px" class="print-hide"></th>
                    </tr>
                </thead>
                <tbody id="order-tbody"></tbody>
            </table>

            <div style="border-top: 2px dashed var(--line); margin: 32px 0;"></div>

            <div class="grid" style="margin-top:10px; grid-template-columns: 1fr 280px; align-items:start">
                <div class="note">æ­¤ç‚ºæ¨¡æ“¬å ±åƒ¹ï¼Œéæ­£å¼è¨‚å–®ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ã€‚å¦‚éœ€è¨‚è³¼ï¼Œ<br>è«‹å°‡æ­¤å–®é€é LINE æä¾›çµ¦æ¥­å‹™äººå“¡ï¼Œå¯¦éš›é‡‘é¡ä»¥æ¥­å‹™äººå“¡ç¢ºèªå¾Œæä¾›ä¹‹ã€æ­£å¼å ±åƒ¹å–®ã€ç‚ºæº–ã€‚</div>
                <div>
                  
                    <div style="display:grid; gap:8px; justify-content:end">
                        <div style="display:grid; grid-template-columns: 1fr 140px; gap:8px"><div>é¤é»å°è¨ˆ</div><div class="right" id="subtotal">0</div></div>
                        
                        <div id="ui-morning-fee-row" class="fee-row" style="display:none; grid-template-columns: 1fr 140px; gap:8px; color:#E53E3E;">
                            <div>æ—©æ™¨åŠ æˆ</div><div class="right" id="morning-fee-val">3,500</div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 140px; gap:8px"><div>äº¤é€šé‹è²»</div><div class="right" id="shipping-fee">500</div></div>

                        <div style="display:grid; grid-template-columns: 1fr 140px; gap:8px; color:var(--muted)"><div>ç‡Ÿæ¥­ç¨… (5%)</div><div class="right" id="tax-amount">0</div></div>

                        <div style="display:grid; grid-template-columns: 1fr 140px; gap:8px; font-weight:700; margin-top:4px; border-top:1px solid var(--line); padding-top:8px;">
                          <div>ç¸½è¨ˆ (å«ç¨…)</div><div class="right" id="grand">0</div>
                        </div>
                    </div>

                    <div style="margin-top: 16px;">
                        <button id="btn-download" style="width:100%">åˆ—å°æ­£å¼å ±åƒ¹å–® (å¦å­˜ PDF)</button>
                        <div class="disclaimer">
                            æ­¤ç‚ºæ¨¡æ“¬å ±åƒ¹ï¼Œéæ­£å¼è¨‚å–®<br>è«‹é€éå®˜æ–¹Lineè¯ç¹«ï¼Œç¶“æ¥­å‹™äººå“¡ç¢ºèªä¸¦æä¾›æ­£å¼å ±åƒ¹å–®å¾Œç‚ºæº–
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    </main>
  </div>

  <div class="modal-overlay" id="successModal">
    <div class="modal-content">
      <div class="modal-icon">ğŸ‰</div>
      <div class="modal-title">å ±åƒ¹å–®å·²æº–å‚™å°±ç·’ï¼</div>
      <div class="modal-text">
        è³‡æ–™å·²æˆåŠŸç´€éŒ„ï¼Œä¸¦æ­£åœ¨é–‹å•Ÿåˆ—å°è¦–çª—ã€‚<br>
        æˆ‘å€‘å°‡æ–¼ <strong>ä¸‹ä¸€å€‹å·¥ä½œæ—¥</strong> (ä¸å«ä¾‹å‡æ—¥)<br>
        ä¸»å‹•èˆ‡æ‚¨è¯ç¹«ç¢ºèªç´°ç¯€ã€‚
      </div>
      <button class="modal-btn" onclick="closeModal()">å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyFSe1U6E363tVmdW6GazEVorQD2pnYUNO5sIPhk_HYyFQhhD_fdfa2-tPapYjndJFQ/exec"; 

  const catalog = [
    { id:'b2-1', category:'äºŒæ ¼ç›’', name:'ç¨å®¶é¦™æ–™é¹¹è±¬è‚‰', price: 200, image:'æ—¥å¼é¹½éº´è±¬äº”èŠ±-2_å·¥ä½œå€åŸŸ 1-2.jpg', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-2', category:'äºŒæ ¼ç›’', name:'æ—¥å¼é¹½éº´è±¬äº”èŠ±', price: 200, image:'æ—¥å¼é¹½éº´è±¬äº”èŠ±-2_å·¥ä½œå€åŸŸ 1-2.jpg', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-3', category:'äºŒæ ¼ç›’', name:'æ—¥å¼é¹½éº´é›è…¿æ’', price: 200, image:'æ—¥å¼é¹½éº´é›è…¿æ’-2_å·¥ä½œå€åŸŸ 1-2.jpg', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-4', category:'äºŒæ ¼ç›’', name:'è”¥æ²¹é›èƒ¸è‚‰', price: 180, image:'è”¥æ²¹é›èƒ¸è‚‰-2.png', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-5', category:'äºŒæ ¼ç›’', name:'æ³•å¼æ²¹å°æé®‘è‡(å…¨ç´ )', price: 180, image:'æ³•å¼æ²¹å°æé®‘è‡(å…¨ç´ )-2.png', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½æ²¹é†‹é†¬(å…¨ç´ )','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹(è›‹å¥¶ç´ )','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯(å…¨ç´ )'] },
    { id:'p4-1', category:'æ¤çº–å››æ ¼ç›’', name:'è‡ªè£½è”¥æ²¹é›èƒ¸è‚‰ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 300, image:'å››æ ¼ç›’_è‡ªè£½è”¥æ²¹é›èƒ¸è‚‰ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)-2.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-2', category:'æ¤çº–å››æ ¼ç›’', name:'æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 320, image:'å››æ ¼ç›’_æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)-2.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-3', category:'æ¤çº–å››æ ¼ç›’', name:'è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 320, image:'å››æ ¼ç›’_é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-4', category:'æ¤çº–å››æ ¼ç›’', name:'é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 320, image:'å››æ ¼ç›’_è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)-2.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-5', category:'æ¤çº–å››æ ¼ç›’', name:'ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 420, image:'å››æ ¼ç›’_ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-6', category:'æ¤çº–å››æ ¼ç›’', name:'æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 320, image:'å››æ ¼ç›’_æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-7', category:'æ¤çº–å››æ ¼ç›’', name:'æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼ç…§ç‡’æ¤ç‰©è‚‰', price: 320, image:'å››æ ¼ç›’_æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼ç…§ç‡’æ¤ç‰©è‚‰.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['ä¸»èœ2: æ—¥å¼ç…§ç‡’æ¤ç‰©è‚‰','é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] }, 
    { id:'k8-1', category:'éŸ“å¼å…«æ ¼ç›’', name:'éŸ“å¼ç‚¸é› + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 280, image:'éŸ“å¼ç‚¸é› + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)-3.png', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-2', category:'éŸ“å¼å…«æ ¼ç›’', name:'æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 280, image:'æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)-3.png', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-3', category:'éŸ“å¼å…«æ ¼ç›’', name:'ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 380, image:'ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰.png', meta:'éŸ“å¼è™•ç†å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-4', category:'éŸ“å¼å…«æ ¼ç›’', name:'æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 280, image:'å…«æ ¼ç›’_æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰.png', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-5', category:'éŸ“å¼å…«æ ¼ç›’', name:'è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 280, image:'è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰.png', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-6', category:'éŸ“å¼å…«æ ¼ç›’', name:'é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', price: 280, image:'é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰.png', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-7', category:'éŸ“å¼å…«æ ¼ç›’', name:'æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼ç…§ç‡’æ¤ç‰©è‚‰', price: 280, image:'æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼ç…§ç‡’æ¤ç‰©è‚‰.png', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
  ];

  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const money = n => new Intl.NumberFormat('zh-Hant', { maximumFractionDigits: 0 }).format(n||0);

  const selCategory = $('#sel-category');
  const selItem = $('#sel-item');
  const selPrice = $('#sel-price');
  const selQty = $('#sel-qty');
  const orderTbody = $('#order-tbody');
  const previewImg = $('#preview-img');
  const previewPlaceholder = $('#preview-placeholder');
  const previewTitle = $('#preview-title');
  const previewDesc = $('#preview-desc');

  /* ğŸŸ¢ğŸŸ¢ğŸŸ¢ æ–°å¢ï¼šè¨‚å–®ç·¨è™Ÿç”Ÿæˆé‚è¼¯ ğŸŸ¢ğŸŸ¢ğŸŸ¢ */
  function generateOrderID() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const dateStr = `${year}${month}${day}`;
      
      // ç”Ÿæˆ 4 ä½å¤§å¯«è‹±æ•¸çµ„åˆ
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let randomStr = '';
      for (let i = 0; i < 4; i++) {
          randomStr += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      return `MJ${dateStr}${randomStr}`;
  }
  /* ğŸŸ¢ğŸŸ¢ğŸŸ¢ çµæŸï¼šè¨‚å–®ç·¨è™Ÿç”Ÿæˆé‚è¼¯ ğŸŸ¢ğŸŸ¢ğŸŸ¢ */

  /* ğŸŸ¢ æ ¡é©—é‚è¼¯ ğŸŸ¢ */
  function validateVAT(vat) {
      if (!/^\d{8}$/.test(vat)) return false;
      const multipliers = [1, 2, 1, 2, 1, 2, 4, 1];
      let sum = 0;
      for (let i = 0; i < 8; i++) {
          let prod = parseInt(vat[i]) * multipliers[i];
          sum += Math.floor(prod / 10) + (prod % 10);
      }
      if (sum % 10 === 0) return true;
      if (vat[6] === '7' && (sum + 1) % 10 === 0) return true;
      return false;
  }

  function containsPrankKeywords(str) {
      const blacklist = ['æ¸¬è©¦', 'test', 'ç„¡', '12345', 'è·¯äºº', 'å“ˆå“ˆå“ˆ', 'asdf'];
      return blacklist.some(key => str.toLowerCase().includes(key));
  }

  $$('input[name="tax-type"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
          const taxInput = $('#tax-id');
          if (e.target.value === 'individual') {
              taxInput.value = 'å€‹äºº';
              taxInput.disabled = true;
              taxInput.style.backgroundColor = '#f1f1f1';
              taxInput.style.color = '#718096';
          } else {
              taxInput.value = '';
              taxInput.disabled = false;
              taxInput.style.backgroundColor = '#fff';
              taxInput.style.color = 'var(--ink)';
          }
      });
  });

  function performStrictValidation() {
      const client = $('#client').value.trim();
      const taxType = $('input[name="tax-type"]:checked').value;
      const vat = $('#tax-id').value.trim();
      const phone = $('#phone').value.trim();
      const address = $('#address').value.trim();
      const date = $('#date').value;
      const time = $('#time').value;

      if (!client || !phone || !address || !date || !time) {
          alert("âš ï¸ è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚"); return false;
      }
      if (containsPrankKeywords(client) || containsPrankKeywords(address)) {
          alert("âš ï¸ åµæ¸¬åˆ°ç„¡æ•ˆå…§å®¹ï¼Œè«‹è¼¸å…¥çœŸå¯¦è³‡è¨Šã€‚"); return false;
      }
      if (taxType === 'company') {
          if (!vat || vat === 'å€‹äºº') { alert("âš ï¸ è«‹å‹™å¿…è¼¸å…¥å…¬å¸çµ±ç·¨ã€‚"); return false; }
          if (!validateVAT(vat)) { alert("âš ï¸ çµ±ç·¨æ ¡é©—å¤±æ•—ã€‚"); return false; }
      }
      if (!/^09\d{8}$/.test(phone)) { alert("âš ï¸ æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤ã€‚"); return false; }
      if (address.length < 10 || !(/[ç¸£å¸‚]/.test(address))) { alert("âš ï¸ åœ°å€éœ€å«ç¸£å¸‚ã€‚"); return false; }
      return true;
  }

  async function sendToGas(payload) {
      try {
          await fetch(GAS_URL, {
              method: "POST",
              body: JSON.stringify(payload),
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              mode: "no-cors"
          });
      } catch (err) { console.error("GAS Error:", err); }
  }

  function sendStage1Info() {
      const payload = {
          stage: "client_info",
          order_id: $('#order-id').value, // ğŸŸ¢ åŒæ­¥è¨‚å–®ç·¨è™Ÿ
          client_name: $('#client').value.trim(),
          tax_id: $('#tax-id').value.trim(),
          contact_phone: $('#phone').value.trim(),
          delivery_address: $('#address').value.trim(),
          order_date: $('#date').value,
          delivery_time: $('#time').value,
          timestamp: new Date().toLocaleString()
      };
      sendToGas(payload);
  }

  function goToStep(step) {
      if (step === 2) {
          if (!performStrictValidation()) return;
          sendStage1Info();
          $('#step-1-wrapper').style.display = 'none';
          $('#step-2-wrapper').style.display = 'block';
          $('#step-nav-1').classList.remove('active');
          $('#step-nav-2').classList.add('active');
          window.scrollTo(0, 0); 
      } else {
          $('#step-2-wrapper').style.display = 'none';
          $('#step-1-wrapper').style.display = 'block';
          $('#step-nav-2').classList.remove('active');
          $('#step-nav-1').classList.add('active');
          window.scrollTo(0, 0);
      }
  }

  function recalc(){
    let subtotal = 0;
    $$('#order-tbody tr').forEach(tr => {
      const p = Number(tr.dataset.price||0); 
      const q = Number(tr.dataset.qty||0);
      const line = p * q; 
      subtotal += line; 
      tr.querySelector('.line-subtotal').textContent = money(line);
    });

    const timeValue = $('#time').value;
    let morningFee = 0;
    const morningAlert = $('#morning-fee-alert'); 
    const eveningAlert = $('#evening-alert');
    const uiRow = $('#ui-morning-fee-row'); 
    
    morningAlert.style.display = eveningAlert.style.display = uiRow.style.display = 'none';
    $('#btn-download').disabled = false;

    if (timeValue) {
        if (timeValue < '10:00') { morningFee = 3500; morningAlert.style.display = 'block'; uiRow.style.display = 'grid'; }
        else if (timeValue > '18:00') { eveningAlert.style.display = 'block'; $('#btn-download').disabled = true; }
    }

    const shippingFee = 500;
    const taxBase = subtotal + morningFee + shippingFee;
    const taxAmount = Math.round(taxBase * 0.05);
    const grandTotal = taxBase + taxAmount;

    $('#subtotal').textContent = money(subtotal);
    $('#morning-fee-val').textContent = money(morningFee);
    $('#shipping-fee').textContent = money(shippingFee);
    $('#tax-amount').textContent = money(taxAmount);
    $('#grand').textContent = money(grandTotal);
  }

  function addRow({ itemId, price, qty }){
    const item = catalog.find(x => x.id === itemId);
    if (!item) return;
    const tr = document.createElement('tr');
    tr.dataset.price = String(price);
    tr.dataset.qty = String(qty);
    tr.dataset.group = item.category;
    tr.dataset.itemId = item.id;
    const imgHtml = item.image ? `<img src="${item.image}" style="width:70px; height:50px; object-fit:cover; border-radius:4px; border:1px solid #eee;">` : '--';
    tr.innerHTML = `
      <td style="text-align:center;">${imgHtml}</td>
      <td style="white-space:pre-wrap; font-weight:500;">${item.name}</td>
      <td class="right">${money(price)}</td>
      <td class="right">${money(qty)}</td>
      <td class="right line-subtotal">0</td>
      <td class="right print-hide"><button type="button" class="btn-del" style="padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff">åˆªé™¤</button></td>
    `;
    tr.querySelector('.btn-del').addEventListener('click', () => {
      if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.name}ã€å—ï¼Ÿ`)) { tr.remove(); recalc(); }
    });
    orderTbody.appendChild(tr);
    recalc();
  }

  /* é¸å–®é‚è¼¯ */
  const preferredOrder = ['äºŒæ ¼ç›’', 'æ¤çº–å››æ ¼ç›’', 'éŸ“å¼å…«æ ¼ç›’'];
  const categories = [...new Set(catalog.map(x => x.category))];
  categories.sort((a,b)=>{
    const ia = preferredOrder.indexOf(a), ib = preferredOrder.indexOf(b);
    if (ia !== -1 && ib !== -1) return ia - ib;
    return a.localeCompare(b,'zh-Hant');
  });
  categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c; selCategory.appendChild(opt);
  });

  selCategory.addEventListener('change', () => {
    selItem.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç¨®é¡</option>';
    selItem.disabled = !selCategory.value;
    if (selCategory.value) {
      catalog.filter(x => x.category === selCategory.value).forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.id;
        opt.textContent = `${item.name} ($${item.price} æœªç¨…)`;
        selItem.appendChild(opt);
      });
    }
    resetPreview();
  });

  function resetPreview() {
    previewImg.style.display = 'none'; previewPlaceholder.style.display = 'block';
    previewTitle.textContent = '--'; previewDesc.textContent = 'é¸æ“‡é¤é»å¾Œå°‡é¡¯ç¤ºè©³ç´°é…èœå…§å®¹';
  }

  selItem.addEventListener('change', () => {
    const item = catalog.find(x => x.id === selItem.value);
    if (!item) return;
    selPrice.value = item.price || 0;
    previewTitle.textContent = item.name;
    previewDesc.innerHTML = item.includes ? item.includes.join('<br>') : item.meta;
    if (item.image) { previewImg.src = item.image; previewImg.style.display = 'block'; previewPlaceholder.style.display = 'none'; }
  });

  $('#btn-add').addEventListener('click', () => {
    if (!selItem.value) { alert('è«‹é¸æ“‡é¤é»'); return; }
    addRow({ itemId: selItem.value, price: Number(selPrice.value), qty: Number(selQty.value) });
    selQty.value = 1;
  });

  async function handlePrintProcess() {
    const rows = $$('#order-tbody tr');
    if (rows.length === 0) { alert('âš ï¸ è«‹å…ˆåŠ å…¥é¤é»ã€‚'); return; }

    const btn = $('#btn-download');
    btn.disabled = true; btn.textContent = 'è³‡æ–™åŠ å¯†å‚³é€ä¸­...';

    const itemsData = rows.map(tr => ({
        image_url: tr.querySelector('img') ? tr.querySelector('img').src : "ç„¡åœ–ç‰‡",
        name: tr.children[1].textContent, 
        price: Number(tr.dataset.price),
        qty: Number(tr.dataset.qty), 
        subtotal: Number(tr.dataset.qty) * Number(tr.dataset.price)
    }));

    const payload = {
        stage: "full_quote",
        order_id: $('#order-id').value, // ğŸŸ¢ åŒæ­¥è¨‚å–®ç·¨è™Ÿ
        client_name: $('#client').value.trim(),
        tax_id: $('#tax-id').value.trim(),
        contact_phone: $('#phone').value,
        delivery_address: $('#address').value,
        order_date: $('#date').value,
        delivery_time: $('#time').value,
        items: itemsData,
        amounts: {
          subtotal: $('#subtotal').textContent,
          morning_fee: $('#morning-fee-val').textContent,
          shipping: $('#shipping-fee').textContent,
          tax: $('#tax-amount').textContent,
          total_with_tax: $('#grand').textContent
        }
    };

    await sendToGas(payload);
    showModal();

    const originalTitle = document.title;
    // ğŸŸ¢ğŸŸ¢ğŸŸ¢ PDF é¡¯ç¤ºä½ç½®èˆ‡æª”åå„ªåŒ– ğŸŸ¢ğŸŸ¢ğŸŸ¢
    document.title = `æ­£å¼å ±åƒ¹å–®_${$('#order-id').value}_${$('#client').value.trim()}`;

    btn.textContent = 'åˆ—å°æ­£å¼å ±åƒ¹å–® (å¦å­˜ PDF)';
    btn.disabled = false;

    setTimeout(() => {
        window.print();
        document.title = originalTitle;
    }, 600);
  }

  function showModal() {
    const m = $('#successModal'); m.style.display = 'flex';
    setTimeout(() => m.classList.add('active'), 10);
  }

  function closeModal() {
    const m = $('#successModal'); m.classList.remove('active');
    setTimeout(() => m.style.display = 'none', 300);
  }

  $('#btn-download').onclick = handlePrintProcess;
  window.closeModal = closeModal;

  (function initMeta(){
    // ğŸŸ¢ğŸŸ¢ğŸŸ¢ åˆå§‹åŒ–è¨‚å–®ç·¨è™Ÿ ğŸŸ¢ğŸŸ¢ğŸŸ¢
    $('#order-id').value = generateOrderID();
    
    const d = new Date(); d.setDate(d.getDate() + 7);
    $('#date').value = d.toISOString().split('T')[0];
    $('#date').min = d.toISOString().split('T')[0];
  })();

  $('#time').addEventListener('input', recalc);
</script>
</body>
</html>
