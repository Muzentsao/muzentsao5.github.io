<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>æœ¨äººè‰¸xæ­£é¤é¤ç›’å ±åƒ¹å–®</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* CSS æ¨£å¼ç¶­æŒä¸è®Š */
:root { 
  --primary: #FF8C42; 
  --primary-light: #FFF0E6; 
  --secondary: #4CAF50; 
  --tertiary: #E3F2FD; 
  --ink: #2D3748; 
  --muted: #718096; 
  --light-gray: #F7FAFC; 
  --line: #E2E8F0; 
  --danger: #E53E3E; 
  --warning-bg: #FFF4E5; 
  --warning-text: #663C00; 
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
  --shadow: 0 4px 12px rgba(0,0,0,0.08);
  --radius: 16px; 
  --radius-sm: 12px; 
  --transition: all 0.2s ease; 
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body { 
  font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "Segoe UI", Roboto, Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; 
  background: var(--light-gray); 
  color: var(--ink);
  line-height: 1.5;
}

.container { 
  max-width: 1200px; 
  margin: 0 auto 32px auto; 
  background: #fff; 
  border-radius: var(--radius); 
  box-shadow: var(--shadow); 
  overflow: hidden; 
  border: 1px solid var(--line);
}  

header { 
  padding: 24px 32px; 
  border-bottom: 1px solid var(--line); 
  display: flex; 
  gap: 24px; 
  align-items: center; 
  justify-content: center; 
  flex-wrap: wrap; 
  background-color: var(--primary-light);
}

h1 { font-size: 24px; color: var(--primary); font-weight: 700; margin-bottom: 0; }
.muted { color: var(--muted); font-size: 14px; margin-top: 4px; }

#btn-download, #btn-add { 
  padding: 12px 20px; 
  border: none; 
  border-radius: var(--radius-sm); 
  background: var(--primary); 
  color: #fff; 
  cursor: pointer; 
  font-weight: 600; 
  transition: var(--transition); 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  gap: 8px;
}
#btn-download::before { content: "ğŸ“¥"; }
#btn-add::before { content: "â•"; }
#btn-download:hover, #btn-add:hover { background: #E07B39; transform: translateY(-2px); box-shadow: var(--shadow-sm); }
#btn-download:active, #btn-add:active { transform: translateY(0); }

main { padding: 28px 32px; }

.block { 
  border: 1px solid var(--line); 
  border-radius: var(--radius); 
  padding: 20px; 
  background-color: #fff; 
  box-shadow: var(--shadow-sm); 
  margin-bottom: 20px;
}

.grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
.row { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); align-items: end; margin-top: 12px; }

label { display: block; font-size: 14px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }

input[type="text"], input[type="date"], input[type="number"], input[type="tel"], textarea, select, input[type="time"] { 
  width: 100%; 
  padding: 12px 16px; 
  border: 1px solid var(--line); 
  border-radius: var(--radius-sm); 
  font-size: 16px; 
  height: 48px; 
  transition: var(--transition); 
  color: var(--ink);
  background: #fff; /* ç¢ºä¿èƒŒæ™¯è‰² */
}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--tertiary); }

/* --- é è¦½å¡ç‰‡ä½ˆå±€ --- */
.selection-wrapper {
  display: flex;
  gap: 24px;
  align-items: start;
}
.selection-left { flex: 2; } 
.selection-right { 
  flex: 1; 
  min-width: 250px;
  background: var(--light-gray);
  border-radius: var(--radius);
  border: 1px solid var(--line);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.preview-box {
  flex-grow: 1;
  background: #eee;
  position: relative;
  height: 240px;      
  width: 100%;        
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border-bottom: 1px solid var(--line); 
}
.preview-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none; 
}
.preview-placeholder {
  color: var(--muted);
  font-size: 14px;
  text-align: center;
  line-height: 1.6;
}
.preview-info {
  padding: 16px;
  background: #fff;
  border-top: 1px solid var(--line);
}
.preview-title { font-weight: 700; color: var(--primary); margin-bottom: 4px; font-size: 16px; }
.preview-desc { font-size: 13px; color: var(--muted); line-height: 1.4; }

table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 16px; border: 1px solid var(--line); border-radius: var(--radius-sm); overflow: hidden; }
th, td { border-bottom: 1px solid var(--line); border-right: 1px solid var(--line); padding: 12px 16px; text-align: left; vertical-align: middle; }
th:last-child, td:last-child { border-right: none; }
tr:last-child td { border-bottom: none; }
thead th { background: var(--light-gray); color: var(--ink); font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
tbody tr:hover { background-color: var(--primary-light); transition: var(--transition); }
.right { text-align: right; color: var(--secondary); font-weight: 500; }
.note { margin-top: 12px; color: var(--muted); font-size: 13px; line-height: 1.4; padding-left: 20px; position: relative; }
.note::before { content: "â„¹ï¸"; position: absolute; left: 0; top: 0; }
.btn-del { padding: 6px 12px; border: 1px solid var(--danger); border-radius: var(--radius-sm); background: #fff; color: var(--danger); cursor: pointer; transition: var(--transition); font-size: 14px; }
.btn-del:hover { background: var(--danger); color: #fff; }
#subtotal, #grand { font-size: 18px; font-weight: 700; }
#grand { color: var(--primary); font-size: 20px; }

/* è¼”åŠ©æ–‡å­—æ¨£å¼ */
.input-hint { font-size: 12px; color: var(--danger); margin-top: 4px; display: block; }

/* å…è²¬è²æ˜æ¨£å¼ */
.disclaimer {
  margin-top: 12px;
  font-size: 13px;
  color: #718096;
  text-align: center;
  background: #EDF2F7;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #E2E8F0;
}

/* å½ˆè·³è¦–çª— Modal æ¨£å¼ */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
.modal-overlay.active {
  opacity: 1;
  pointer-events: auto;
}
.modal-content {
  background: #fff;
  width: 90%;
  max-width: 400px;
  padding: 32px 24px;
  border-radius: 24px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  transform: translateY(20px);
  transition: transform 0.3s ease;
}
.modal-overlay.active .modal-content {
  transform: translateY(0);
}
.modal-icon {
  font-size: 48px;
  margin-bottom: 16px;
  display: block;
}
.modal-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--ink);
  margin-bottom: 12px;
}
.modal-text {
  font-size: 15px;
  color: var(--muted);
  line-height: 1.6;
  margin-bottom: 24px;
}
.modal-btn {
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 12px 32px;
  border-radius: 50px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: background 0.2s;
}
.modal-btn:hover {
  background: #e07b39;
}

/* ğŸ”¥ğŸ”¥ğŸ”¥ æ—¥æœŸèˆ‡æ™‚é–“çš„ä½ˆå±€æ¨£å¼ ğŸ”¥ğŸ”¥ğŸ”¥ */
.date-time-wrapper {
  display: grid;
  grid-template-columns: 2fr 1fr; /* æ—¥æœŸå¯¬ä¸€é»ï¼Œæ™‚é–“çª„ä¸€é» */
  gap: 12px;
}

/* âœ¨âœ¨âœ¨ æ—©æ™¨åŠ æˆæç¤ºæ¡†æ¨£å¼ (å«å‹•ç•«) âœ¨âœ¨âœ¨ */
.morning-fee-alert {
  display: none; /* é è¨­éš±è— */
  margin-top: 10px;
  padding: 12px 16px;
  background-color: #FFF4E5; /* æ·ºæ©˜é»ƒè‰²èƒŒæ™¯ */
  border: 1px solid #FCD34D; /* æ·±é»ƒè‰²é‚Šæ¡† */
  border-radius: 8px;
  color: #92400E; /* æ·±è¤è‰²æ–‡å­— */
  font-size: 14px;
  line-height: 1.5;
  animation: fadeIn 0.3s ease-in-out;
}
.morning-fee-alert strong {
  font-weight: 700;
  color: #B45309;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
  .hero-section { padding: 3rem 1.5rem !important; text-align: center; }
  .hero-text-area { text-align: center; margin-bottom: 2rem; }
  .hero-btn { width: 100%; text-align: center; }

  header { padding: 16px 20px; gap: 16px; }
  h1 { font-size: 20px; }
  main { padding: 20px 16px; }
  .grid, .row { gap: 16px; }
  .block { padding: 16px; }
  th, td { padding: 10px 12px; }
  #btn-download, #btn-add { padding: 10px 16px; font-size: 14px; }
   
  .selection-wrapper { flex-direction: column; }
  .selection-right { min-height: 250px; }
   
  /* æ‰‹æ©Ÿç‰ˆï¼šæ—¥æœŸæ™‚é–“è®Šæˆä¸Šä¸‹æ’ */
  .date-time-wrapper {
    grid-template-columns: 1fr;
    gap: 8px;
  }
}

@media print { 
  .hero-section { display: none !important; }
  .toolbar, .btn-row, details, #btn-download { display: none !important; } 
  .container { margin: 0; border: none; border-radius: 0; box-shadow: none; } 
  header { background: #fff; border-bottom: none; display: flex !important; } 
  h1 { color: var(--ink); }
  .modal-overlay { display: none !important; }
}
</style>
</head>
<body>

  <section class="hero-section" style="width:100%; background:#f9f7f4; padding:5rem 2rem; margin-bottom:2rem; position:relative; overflow:hidden;">
    <div style="position:absolute; top:-20%; right:-10%; width:40%; height:40%; background:#e8f4ea; border-radius:50%; opacity:0.6;"></div>
    <div style="position:absolute; bottom:-15%; left:-8%; width:30%; height:30%; background:#f0ebe2; border-radius:50%; opacity:0.6;"></div>
    
    <div style="max-width:1200px; margin:0 auto; position:relative; z-index:2;">
      <div style="display:flex; flex-wrap:wrap; align-items:center; gap:3rem;">
        
        <div class="hero-text-area" style="flex:1 1 500px;">
          <h1 style="font-size:2.8rem; color:#2d3748; margin:0 0 1rem 0; line-height:1.3; font-weight:700;">
            æœ¨äººè‰¸xæ­£é¤é¤ç›’<br>
            <span style="color:#FF8C42;">å¥åº·é£²é£Ÿï¼Œç¾å‘³æº–æ™‚ç›´é€ã€‚</span>
          </h1>
          <p style="font-size:1.1rem; color:#4a5568; margin:0 0 1.5rem 0; line-height:1.6; max-width:600px;">
            ç²¾é¸æ–°é®®é£Ÿæï¼Œå¤šç¨®å¥—é¤é¸æ“‡ï¼ˆäºŒæ ¼ç›’/æ¤çº–å››æ ¼ç›’/éŸ“å¼å…«æ ¼ç›’ï¼‰ï¼Œé©åˆä¼æ¥­åœ˜é¤ã€æ´»å‹•ä¾›æ‡‰ã€åœ˜é«”è¨‚è³¼ã€‚
          </p>
          
          <div style="background: #fff; border-left: 4px solid #E53E3E; padding: 16px; margin-bottom: 2rem; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
            <div style="display:flex; flex-direction:column; gap:8px;">
                <p style="margin:0; color:#E53E3E; font-weight:600; font-size: 1rem;">
                  âš ï¸ å»ºè­°180å…ƒ/äººèµ·è·³
                  <span style="font-size:0.9em; color:#718096; font-weight:400;">(æœªç¨…æœªå«äº¤é€šè²»)</span>
                </p>
                <p style="margin:0; color:#2D3748; font-weight:500; font-size: 0.95rem;">
                  ğŸš› æœå‹™ç¯„åœåƒ…é™é›™åŒ—åœ°å€ <span style="font-size:0.9em; color:#718096; font-weight:400;">(å±±å€åŠåé åœ°å€é™¤å¤–)</span>
                </p>
                <p style="margin:0; color:#2D3748; font-weight:500; font-size: 0.95rem;">
                  â³ éœ€æå‰ 5 å€‹å·¥ä½œå¤©é è¨‚ <span style="font-size:0.9em; color:#718096; font-weight:400;">(ä¸å«ä¾‹å‡æ—¥ï¼Œç¢ºä¿é£Ÿææ–°é®®æº–å‚™)</span>
                </p>
            </div>
          </div>

          <a href="#order-form" class="hero-btn" style="display:inline-block; background:#FF8C42; color:white; padding:1rem 2.5rem; border-radius:50px; font-size:1.1rem; font-weight:600; text-decoration:none; transition:all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);">
            ç«‹å³é¸å“å ±åƒ¹ â–¼
          </a>
        </div>
        
        <div style="flex:1 1 400px; text-align:center;">
          <img src="Gemini_Generated_Image_iwrfd3iwrfd3iwrf.jpg" alt="æœ¨äººè‰¸æ­£é¤é¤ç›’å±•ç¤º" style="width:100%; max-width:500px; height:auto; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.1); object-fit: cover;">
        </div>
      </div>
    </div>
  </section>


  <div class="container" id="order-form">
    <main>
  <section class="block">
    <label style="font-weight:600;color:#374151; margin-bottom:12px; display:block">å¿«é€Ÿé¸å“ï¼ˆå±¤ç´šä¸‹æ‹‰ï¼‰</label>
    
    <div class="selection-wrapper">
      <div class="selection-left">
        <div class="row" style="margin-top:0">
          <div style="grid-column: 1 / -1">
            <label>ä¾¿ç•¶ç¨®é¡ï¼ˆé¤ç›’é¡åˆ¥ï¼‰</label>
            <select id="sel-category"><option value="" disabled selected>è«‹é¸æ“‡ä¾¿ç•¶ç¨®é¡</option></select>
          </div>
          <div style="grid-column: 1 / -1">
            <label>é¤ç›’ç¨®é¡</label>
            <select id="sel-item" disabled><option value="" disabled selected>è«‹å…ˆé¸ä¾¿ç•¶ç¨®é¡</option></select>
          </div>
          <div>
            <label>å–®åƒ¹ <span style="font-size:13px; color:#E53E3E;">(æœªç¨…)</span></label>
            <input id="sel-price" type="number" min="0" step="1" value="0" readonly>
          </div>
          <div>
            <label>æ•¸é‡</label>
            <input id="sel-qty" type="number" min="1" step="1" value="1">
          </div>
          <div style="display:flex; align-items:end;">
            <button id="btn-add" style="width:100%; height:48px;">åŠ å…¥æ˜ç´°</button>
          </div>
        </div>
      </div>

      <div class="selection-right">
        <div class="preview-box">
          <div class="preview-placeholder" id="preview-placeholder">
            è«‹é¸æ“‡å·¦å´é¤é»<br>ä»¥æª¢è¦–åœ–ç‰‡èˆ‡å…§å®¹
          </div>
          <img id="preview-img" src="" alt="é¤é»é è¦½">
        </div>
        <div class="preview-info">
          <div class="preview-title" id="preview-title">--</div>
          <div class="preview-desc" id="preview-desc">é¸æ“‡é¤é»å¾Œå°‡é¡¯ç¤ºè©³ç´°é…èœå…§å®¹</div>
        </div>
      </div>
    </div>
  </section>

<section class="block" style="margin-top: 20px;">
    
    <div class="form-header">
      <h2 style="display:flex; align-items:center; justify-content:space-between;">
        è¨‚å–®å…§å®¹ç¢ºèª
        </h2>
      <div class="muted">è«‹ç¢ºèªæ‚¨é¸è³¼çš„é¤é»é …ç›®èˆ‡æ•¸é‡</div>
    </div>

    <table id="order-table">
      <thead>
        <tr>
          <th>é …ç›®åç¨±ï¼ˆä¸»èœï¼‰èˆ‡å…§å®¹</th>
          <th class="right" style="width:120px">å–®åƒ¹ (æœªç¨…)</th>
          <th class="right" style="width:100px">æ•¸é‡</th>
          <th class="right" style="width:140px">å°è¨ˆ</th>
          <th style="width:60px"></th>
        </tr>
      </thead>
      <tbody id="order-tbody"></tbody>
    </table>

    <div style="border-top: 2px dashed var(--line); margin: 32px 0;"></div>

    <div class="form-header">
      <h2>å¡«å¯«è¨‚è³¼è³‡è¨Š & ç¢ºèªæ˜ç´°</h2>
      <div class="muted">è«‹å®Œæ•´å¡«å¯«ä»¥ä¸‹è³‡è¨Šä»¥å»ºç«‹å ±åƒ¹å–®</div>
    </div>

    <div class="form-grid-container">
      <div class="form-group">
        <label>å®¢æˆ¶åç¨± <span class="required-mark">*</span></label>
        <input id="client" type="text" placeholder="è«‹è¼¸å…¥å…¬å¸æˆ–è¨‚è³¼äººåç¨±">
      </div>
      
      <div class="form-group">
        <label>çµ±ä¸€ç·¨è™Ÿ <span class="required-mark">*</span></label>
        <input id="tax-id" type="text" placeholder="è«‹è¼¸å…¥çµ±ä¸€ç·¨è™Ÿ">
      </div>

      <div class="form-group">
        <label>è¯çµ¡é›»è©± <span class="required-mark">*</span></label>
        <input id="phone" type="tel" placeholder="æ‰‹æ©Ÿæˆ–å¸‚è©±">
      </div>

      <div class="form-group">
        <label>å ±åƒ¹/é è¨ˆé€é”æ—¥æœŸ & æ™‚é–“ <span class="required-mark">*</span></label>
        <div class="date-time-wrapper">
          <input id="date" type="date">
          
          <input id="time" type="time" min="09:00" max="19:00" value="12:00">
        </div>
        <small class="input-hint">âš ï¸ éœ€è‡³å°‘æå‰ 5 å€‹å·¥ä½œå¤©é è¨‚ï¼ˆä¸å«å…­æ—¥ï¼‰</small>

        <div id="morning-fee-alert" class="morning-fee-alert">
            ğŸ”” <strong>æ—©æ™¨åŠ æˆæé†’ï¼š</strong><br>
            è‹¥é¤ç›’äº¤é¤æ™‚é–“æ–¼ <strong>æ—©ä¸Š 10:00 ä»¥å‰</strong>ï¼Œå°‡å¦æ”¶å–æ—©æ™¨åŠ æˆè²»ç”¨ <strong>$3,500 å…ƒ</strong> (æœªç¨…)ã€‚
        </div>

      </div>
      <div class="form-group full">
        <label>é…é€åœ°å€ <span class="required-mark">*</span></label>
        <input id="address" type="text" placeholder="è«‹è¼¸å…¥å®Œæ•´é…é€åœ°å€">
      </div>
    </div>
    
    <div style="border-top: 1px solid var(--line); margin: 24px 0;"></div>

    <div class="grid" style="margin-top:10px; grid-template-columns: 1fr 280px; align-items:start">
      <div class="note">æ­¤ç‚ºæ¨¡æ“¬å ±åƒ¹ï¼Œéæ­£å¼è¨‚å–®ï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ã€‚å¦‚éœ€è¨‚è³¼ï¼Œ<br>è«‹å°‡æ­¤å–®é€é LINE æä¾›çµ¦æ¥­å‹™äººå“¡ï¼Œå¯¦éš›é‡‘é¡ä»¥æ¥­å‹™äººå“¡ç¢ºèªå¾Œæä¾›ä¹‹ã€æ­£å¼å ±åƒ¹å–®ã€ç‚ºæº–ã€‚</div>
      <div>
        <div style="display:grid; gap:6px; justify-content:end">
          <div style="display:grid; grid-template-columns: 1fr 140px; gap:8px"><div>å°è¨ˆ</div><div class="right" id="subtotal">0</div></div>
          
          <div id="ui-morning-fee-row" style="display:none; grid-template-columns: 1fr 140px; gap:8px; color:#E53E3E;">
             <div>æ—©æ™¨åŠ æˆ</div><div class="right">3,500</div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 140px; gap:8px; font-weight:700"><div>ç¸½è¨ˆ (æœªç¨…)</div><div class="right" id="grand">0</div></div>
        </div>
        <div style="margin-top: 16px;">
           <button id="btn-download" style="width:100%">ä¸‹è¼‰ Excel (.xlsx)</button>
           <div class="disclaimer">
             æ­¤ç‚ºæ¨¡æ“¬å ±åƒ¹ï¼Œéæ­£å¼è¨‚å–®<br>è«‹é€éå®˜æ–¹Lineè¯ç¹«ï¼Œç¶“æ¥­å‹™äººå“¡ç¢ºèªä¸¦æä¾›æ­£å¼å ±åƒ¹å–®å¾Œç‚ºæº–
           </div>
        </div>
      </div>
    </div>
  </section>
</main>
  </div>

  <div class="modal-overlay" id="successModal">
    <div class="modal-content">
      <div class="modal-icon">ğŸ‰</div>
      <div class="modal-title">å ±åƒ¹å–®å·²ä¸‹è¼‰ï¼</div>
      <div class="modal-text">
        æ„Ÿè¬æ‚¨çš„è©¢åƒ¹ã€‚<br>
        æˆ‘å€‘å°‡æ–¼ <strong>ä¸‹ä¸€å€‹å·¥ä½œæ—¥</strong> (ä¸å«ä¾‹å‡æ—¥)<br>
        ä¸»å‹•èˆ‡æ‚¨è¯ç¹«ç¢ºèªç´°ç¯€ã€‚
      </div>
      <button class="modal-btn" onclick="closeModal()">å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

<script>
  // ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ‚¨çš„ GAS ç¶²å€ (è«‹ç¢ºèªé€™æ˜¯å¦ç‚ºæœ€æ–°éƒ¨ç½²çš„ç¶²å€) ğŸ‘‡ğŸ‘‡ğŸ‘‡
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyFSe1U6E363tVmdW6GazEVorQD2pnYUNO5sIPhk_HYyFQhhD_fdfa2-tPapYjndJFQ/exec"; 

  const PRICE_MAP = { sheets: {}, flat: {} };
  PRICE_MAP.flat = {
    // --- äºŒæ ¼ç›’ ---
    "æ—¥å¼é¹½éº´è±¬äº”èŠ±": 200, 
    "æ—¥å¼é¹½éº´é›è…¿æ’": 200, 
    "ç¨å®¶é¦™æ–™é¹¹è±¬è‚‰": 200, 
    "è”¥æ²¹é›èƒ¸è‚‰": 180, 
    "æ³•å¼æ²¹å°æé®‘è‡(å…¨ç´ )": 180,

    // --- æ¤çº–å››æ ¼ (ä¸­å¼ - é£¯) ---
    "è‡ªè£½è”¥æ²¹é›èƒ¸è‚‰ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 300, 
    "æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 320,
    "è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 320, 
    "é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 320,
    "ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 420, 
    "æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 320,
    "æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼ç…§ç‡’æ¤ç‰©è‚‰": 320, 

    // --- éŸ“å¼å…«æ ¼ ---
    "éŸ“å¼ç‚¸é› + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 280, 
    "æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 280,
    "ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 380, 
    "æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 280,
    "è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 280, 
    "é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 280,
    "æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰": 280
  };

  const catalog = [
    // --- äºŒæ ¼ç›’ ---
    { id:'b2-1', category:'äºŒæ ¼ç›’', name:'ç¨å®¶é¦™æ–™é¹¹è±¬è‚‰', image:'æ—¥å¼é¹½éº´è±¬äº”èŠ±-2_å·¥ä½œå€åŸŸ 1-2.jpg', meta:'äºŒæ ¼ç›’', includes:['ä¸»èœ: ç¨å®¶é¦™æ–™é¹¹è±¬è‚‰','é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-2', category:'äºŒæ ¼ç›’', name:'æ—¥å¼é¹½éº´è±¬äº”èŠ±', image:'æ—¥å¼é¹½éº´è±¬äº”èŠ±-2_å·¥ä½œå€åŸŸ 1-2.jpg', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-3', category:'äºŒæ ¼ç›’', name:'æ—¥å¼é¹½éº´é›è…¿æ’', image:'æ—¥å¼é¹½éº´é›è…¿æ’-2_å·¥ä½œå€åŸŸ 1-2.jpg', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-4', category:'äºŒæ ¼ç›’', name:'è”¥æ²¹é›èƒ¸è‚‰', image:'è”¥æ²¹é›èƒ¸è‚‰-2.png', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'b2-5', category:'äºŒæ ¼ç›’', name:'æ³•å¼æ²¹å°æé®‘è‡(å…¨ç´ )', image:'æ³•å¼æ²¹å°æé®‘è‡(å…¨ç´ )-2.png', meta:'äºŒæ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½æ²¹é†‹é†¬(å…¨ç´ )','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹(è›‹å¥¶ç´ )','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯(å…¨ç´ )'] },

    // --- æ¤çº–å››æ ¼ç›’ (ä¸­å¼-é£¯) ---
    { id:'p4-1', category:'æ¤çº–å››æ ¼ç›’ (ä¸­å¼)', name:'è‡ªè£½è”¥æ²¹é›èƒ¸è‚‰ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'å››æ ¼ç›’_è‡ªè£½è”¥æ²¹é›èƒ¸è‚‰ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)-2.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-2', category:'æ¤çº–å››æ ¼ç›’ (ä¸­å¼)', name:'æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'å››æ ¼ç›’_æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)-2.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-3', category:'æ¤çº–å››æ ¼ç›’ (ä¸­å¼)', name:'è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'å››æ ¼ç›’_è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(50G)-2.png', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-4', category:'æ¤çº–å››æ ¼ç›’ (ä¸­å¼)', name:'é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=600&q=80', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-5', category:'æ¤çº–å››æ ¼ç›’ (ä¸­å¼)', name:'ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=600&q=80', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-6', category:'æ¤çº–å››æ ¼ç›’ (ä¸­å¼)', name:'æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=600&q=80', meta:'æ¤çº–å››æ ¼ç›’', includes:['é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'p4-7', category:'æ¤çº–å››æ ¼ç›’ (ä¸­å¼)', name:'æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼ç…§ç‡’æ¤ç‰©è‚‰', image:'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=600&q=80', meta:'æ¤çº–å››æ ¼ç›’', includes:['ä¸»èœ2: æ—¥å¼ç…§ç‡’æ¤ç‰©è‚‰','é…èœ: ç¶œåˆæº«ä»€è”¬ä½èƒ¡éº»é†¬','é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] }, 

    // --- éŸ“å¼å…«æ ¼ç›’ ---
    { id:'k8-1', category:'éŸ“å¼å…«æ ¼ç›’', name:'éŸ“å¼ç‚¸é› + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'éŸ“å¼ç‚¸é› + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)-2.png', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-2', category:'éŸ“å¼å…«æ ¼ç›’', name:'æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'æ—¥å¼é¹½éº´é›è…¿æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰(40g)-2_å·¥ä½œå€åŸŸ 1.png', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-3', category:'éŸ“å¼å…«æ ¼ç›’', name:'ç‚­çƒ¤ç‰›å°æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'https://images.unsplash.com/photo-1623653387945-2fd25214f8fc?auto=format&fit=crop&w=600&q=80', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-4', category:'éŸ“å¼å…«æ ¼ç›’', name:'æ—¥å¼ç‰›è‚‰æ¼¢å ¡æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'https://images.unsplash.com/photo-1623653387945-2fd25214f8fc?auto=format&fit=crop&w=600&q=80', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-5', category:'éŸ“å¼å…«æ ¼ç›’', name:'è’²ç‡’é¯›é­šè…¹æ’ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'https://images.unsplash.com/photo-1623653387945-2fd25214f8fc?auto=format&fit=crop&w=600&q=80', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-6', category:'éŸ“å¼å…«æ ¼ç›’', name:'é¯–é­šä¸€å¤œå¹² + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'https://images.unsplash.com/photo-1623653387945-2fd25214f8fc?auto=format&fit=crop&w=600&q=80', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
    { id:'k8-7', category:'éŸ“å¼å…«æ ¼ç›’', name:'æ³•å¼æ²¹å°æé®‘è‡ + æ—¥å¼é¹½éº´è±¬äº”èŠ±è‚‰', image:'https://images.unsplash.com/photo-1623653387945-2fd25214f8fc?auto=format&fit=crop&w=600&q=80', meta:'éŸ“å¼å…«æ ¼ç›’', includes:['é…èœ: æ—¥å¼å†·æ³¡æºå¿ƒè›‹','é…èœ: éŸ“å¼æ³¡èœ','ä¸»é£Ÿ: ç´…è—œç§ˆç±³é£¯'] },
  ];

  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
  const money = n => new Intl.NumberFormat('zh-Hant', { maximumFractionDigits: 0 }).format(n||0);

  const selCategory = $('#sel-category');
  const selItem = $('#sel-item');
  const selPrice = $('#sel-price');
  const selQty = $('#sel-qty');
  const orderTbody = $('#order-tbody');
   
  const previewImg = $('#preview-img');
  const previewPlaceholder = $('#preview-placeholder');
  const previewTitle = $('#preview-title');
  const previewDesc = $('#preview-desc');

  // åˆå§‹åŒ–é¡åˆ¥é¸å–® (æ’åºå·²æ›´æ–°ï¼šç§»é™¤è¥¿å¼ç¾©éºµ)
  const preferredOrder = ['äºŒæ ¼ç›’', 'æ¤çº–å››æ ¼ç›’ (ä¸­å¼)', 'éŸ“å¼å…«æ ¼ç›’'];
  const categories = [...new Set(catalog.map(x => x.category))];
  categories.sort((a,b)=>{
    const ia = preferredOrder.indexOf(a), ib = preferredOrder.indexOf(b);
    if (ia !== -1 && ib !== -1) return ia - ib;
    if (ia !== -1) return -1;
    if (ib !== -1) return 1;
    return a.localeCompare(b,'zh-Hant');
  });
  categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    selCategory.appendChild(opt);
  });

  selCategory.addEventListener('change', () => {
    selItem.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç¨®é¡</option>';
    selItem.disabled = !selCategory.value;
    if (selCategory.value) {
      catalog.filter(x => x.category === selCategory.value).forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.id;
        const price = getAutoPriceByName(item.name);
        opt.textContent = `${item.name} (${price ? `$${price}` : '320'} æœªç¨…)`;
        selItem.appendChild(opt);
      });
      selItem.focus();
    }
    resetPreview();
  });

  function getAutoPriceByName(name){
    if (PRICE_MAP && PRICE_MAP.flat && Object.prototype.hasOwnProperty.call(PRICE_MAP.flat, name)) {
      return PRICE_MAP.flat[name];
    }
    return null;
  }

  function resetPreview() {
    previewImg.style.display = 'none';
    previewPlaceholder.style.display = 'block';
    previewPlaceholder.innerHTML = 'è«‹é¸æ“‡å·¦å´é¤é»<br>ä»¥æª¢è¦–åœ–ç‰‡èˆ‡å…§å®¹';
    previewTitle.textContent = '--';
    previewDesc.textContent = 'é¸æ“‡é¤é»å¾Œå°‡é¡¯ç¤ºè©³ç´°é…èœå…§å®¹';
  }

  selItem.addEventListener('change', () => {
    const item = catalog.find(x => x.id === selItem.value);
    if (!item) {
      resetPreview();
      return;
    }
    const p = getAutoPriceByName(item.name);
    selPrice.value = (p != null) ? p : 0;
    previewTitle.textContent = item.name;
    previewDesc.innerHTML = item.includes ? item.includes.join('<br>') : item.meta;
    if (item.image) {
      previewImg.src = item.image;
      previewImg.style.display = 'block';
      previewPlaceholder.style.display = 'none';
    } else {
      previewImg.style.display = 'none';
      previewPlaceholder.style.display = 'block';
      previewPlaceholder.innerHTML = 'æ­¤é¤é»<br>æš«ç„¡åœ–ç‰‡';
    }
  });

  // âœ¨âœ¨âœ¨ æ ¸å¿ƒè¨ˆç®—é‚è¼¯æ›´æ–°ï¼šrecalc åŠ å…¥æ—©æ™¨åŠ æˆåˆ¤æ–· âœ¨âœ¨âœ¨
  function recalc(){
    let subtotal = 0;
    $$('#order-tbody tr').forEach(tr => {
      const price = Number(tr.dataset.price||0);
      const qty = Number(tr.dataset.qty||0);
      const line = price * qty;
      subtotal += line;
      tr.querySelector('.line-subtotal').textContent = money(line);
    });
    
    // å–å¾—æ™‚é–“
    const timeValue = $('#time').value;
    let morningFee = 0;
    
    // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºåŠ æˆæé†’èˆ‡è¨ˆç®—
    const alertBox = document.getElementById('morning-fee-alert');
    const uiRow = document.getElementById('ui-morning-fee-row');
    
    if (timeValue && timeValue < '10:00') {
        morningFee = 3500;
        alertBox.style.display = 'block';
        uiRow.style.display = 'grid'; // é¡¯ç¤ºé‡‘é¡åˆ—
    } else {
        alertBox.style.display = 'none';
        uiRow.style.display = 'none'; // éš±è—é‡‘é¡åˆ—
    }

    $('#subtotal').textContent = money(subtotal);
    // ç¸½è¨ˆ = é¤é»å°è¨ˆ + æ—©æ™¨åŠ æˆ (çš†æœªç¨…)
    $('#grand').textContent = money(subtotal + morningFee);
  }

  function addRow({ itemId, price, qty }){
    const item = catalog.find(x => x.id === itemId);
    if (!item) return;
    const tr = document.createElement('tr');
    tr.dataset.price = String(price);
    tr.dataset.qty = String(qty);
    tr.dataset.group = item.category;
    tr.dataset.itemId = item.id;
    tr.innerHTML = `
      <td style="white-space:pre-wrap">${item.name}</td>
      <td class="right">${money(price)}</td>
      <td class="right">${money(qty)}</td>
      <td class="right line-subtotal">0</td>
      <td class="right"><button type="button" class="btn-del" style="padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff">åˆªé™¤</button></td>
    `;
    tr.querySelector('.btn-del').addEventListener('click', () => {
      if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.name}ã€é€™é …å—ï¼Ÿ`)) {
        tr.remove();
        recalc();
      }
    });
    tr.style.opacity = '0';
    tr.style.transform = 'translateY(10px)';
    orderTbody.appendChild(tr);
    setTimeout(() => {
      tr.style.opacity = '1';
      tr.style.transform = 'translateY(0)';
      tr.style.transition = 'all 0.2s ease';
    }, 10);
    recalc();
  }

  $('#btn-add').addEventListener('click', () => {
    const group = selCategory.value;
    const itemId = selItem.value;
    if (!group) { alert('è«‹å…ˆé¸æ“‡ã€Œä¾¿ç•¶ç¨®é¡ã€'); return; }
    if (!itemId) { alert('è«‹é¸æ“‡ã€Œé¤ç›’ç¨®é¡ã€'); return; }
    const price = Number(selPrice.value||0);
    const qty = Number(selQty.value||1);
    addRow({ itemId, price, qty });
    selQty.value = 1; 
  });

// --- é€å–®èˆ‡ä¸‹è¼‰æµç¨‹ (æœ€çµ‚å®Œæ•´ç‰ˆ) ---
  async function handleOrderSubmit() {
    const MIN_QTY = 10;
    const counts = {};
    const rows = $$('#order-tbody tr');
    
    // --- 1. æª¢æŸ¥æ•¸é‡ ---
    if (rows.length === 0) { alert('âš ï¸ ç›®å‰æ²’æœ‰ä»»ä½•é¤é»ï¼Œè«‹å…ˆåŠ å…¥æ˜ç´°ã€‚'); return; }
    rows.forEach(tr => {
      const category = tr.dataset.group;
      const qty = Number(tr.dataset.qty || 0);
      if (!counts[category]) counts[category] = 0;
      counts[category] += qty;
    });
    const invalidCategories = [];
    for (const [cat, count] of Object.entries(counts)) {
      if (count < MIN_QTY) invalidCategories.push(`${cat} (ç›®å‰ ${count} ç›’)`);
    }
    if (invalidCategories.length > 0) {
      alert(`âš ï¸ è¨‚è³¼é‡ä¸è¶³ï¼\n\næ ¹æ“šè¦å‰‡ï¼Œæ¯ç¨®ç›’å‹éœ€è‡³å°‘æ»¿ ${MIN_QTY} ç›’ã€‚\n\nä»¥ä¸‹ç›’å‹æœªé”æ¨™ï¼š\n- ${invalidCategories.join('\n- ')}\n\nè«‹èª¿æ•´æ•¸é‡å¾Œå†è©¦ã€‚`);
      return; 
    }

    // --- 2. æº–å‚™è³‡æ–™ & åš´æ ¼é©—è­‰ ---
    const client = ($('#client').value || '').trim();
    const taxId = ($('#tax-id').value || '').trim();
    const phone = ($('#phone').value || '').trim();
    const address = ($('#address').value || '').trim();
    const date = ($('#date').value || '').trim();
    const time = ($('#time').value || '').trim();

    // æª¢æŸ¥æ˜¯å¦æœ‰ç©ºå€¼
    if (!client || !taxId || !phone || !address || !date || !time) {
        alert('âš ï¸ è³‡æ–™ä¸å®Œæ•´ï¼\n\nç‚ºäº†ç¢ºä¿å ±åƒ¹å–®æ­£ç¢ºï¼Œè«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼š\n\n- å®¢æˆ¶åç¨±\n- çµ±ä¸€ç·¨è™Ÿ\n- è¯çµ¡é›»è©±\n- é…é€åœ°å€\n- é è¨ˆæ—¥æœŸèˆ‡æ™‚é–“'); 
        
        if(!client) $('#client').focus();
        else if(!taxId) $('#tax-id').focus();
        else if(!phone) $('#phone').focus();
        else if(!date) $('#date').focus();
        else if(!time) $('#time').focus(); 
        else if(!address) $('#address').focus();
        
        return; 
    }

    // é–å®šæŒ‰éˆ•
    const btn = $('#btn-download');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'è™•ç†ä¸­...';

    // âœ¨âœ¨âœ¨ è¨ˆç®—é‡‘é¡ (åŠ å…¥æ—©æ™¨åŠ æˆé‚è¼¯) âœ¨âœ¨âœ¨
    const itemsData = rows.map(tr => ({
        name: tr.children[0].textContent,
        qty: Number(tr.dataset.qty),
        price: Number(tr.dataset.price),
        subtotal: Number(tr.dataset.qty) * Number(tr.dataset.price)
    }));
    
    const subtotal = itemsData.reduce((a,b)=>a+b.subtotal, 0);
    const shipping = 500;
    
    // æª¢æŸ¥æ™‚é–“æ˜¯å¦å°æ–¼ 10:00
    let morningFee = 0;
    if (time && time < '10:00') {
        morningFee = 3500;
    }

    // ç¨…é‡‘è¨ˆç®—åŸºç¤ = é¤é» + é‹è²» + æ—©æ™¨åŠ æˆ
    const taxBase = subtotal + shipping + morningFee;
    const tax = Math.round(taxBase * 0.05);
    const total = taxBase + tax;

    const payload = {
        client_name: client,
        tax_id: taxId,
        contact_phone: phone,
        delivery_address: address,
        order_date: date,
        delivery_time: time, 
        items: itemsData,
        totals: {
            subtotal: money(subtotal),
            shipping: money(shipping),
            morning_fee: money(morningFee), // å‚³çµ¦å¾Œç«¯
            tax: money(tax),
            total: money(total)
        }
    };

    // --- 3. ç™¼é€è³‡æ–™çµ¦ GAS ---
    try {
        console.log("æ­£åœ¨å‚³é€è³‡æ–™çµ¦ GAS...");
        
        await fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            mode: "no-cors"
        });

        console.log("GAS ç™¼é€å®Œæˆ (æˆ–å·²é€å‡ºè«‹æ±‚)");

    } catch (err) {
        console.error("ç™¼é€å¤±æ•—ï¼Œä½†ä»ç¹¼çºŒä¸‹è¼‰ Excel:", err);
    }

    // --- 4. ä¸‹è¼‰ Excel ---
    generateExcelFile(client, taxId, phone, address, date, rows, subtotal, shipping, morningFee, tax, total, time);
    
    // é¡¯ç¤ºæˆåŠŸè¦–çª—
    showModal();
    
    // æ¢å¾©æŒ‰éˆ•
    btn.disabled = false;
    btn.textContent = originalText;
  }

  // æ ¸å¿ƒ Excel ç”Ÿæˆé‚è¼¯ (æ–°å¢ morningFee åƒæ•¸)
  function generateExcelFile(client, taxId, phone, address, date, rows, subtotal, shipping, morningFee, tax, total, time) {
    const filename = `å ±åƒ¹å–®_${client}_${date}.xlsx`;
    const excelRows = [];
    excelRows.push(['æ­£é¤é¤ç›’å ±åƒ¹å–®']);
    excelRows.push(['å»ºè­°180å…ƒ/äººèµ·è·³ (æœªç¨…)ã€‚æœå‹™ç¯„åœï¼šé›™åŒ—åœ°å€ (å±±å€/åé åœ°å€é™¤å¤–)ã€‚']);
    excelRows.push(['æ³¨æ„ï¼šæ­¤ç‚ºæ¨¡æ“¬å ±åƒ¹ï¼Œéæ­£å¼è¨‚å–®ï¼Œè«‹é€éå®˜æ–¹Lineè¯ç¹«ï¼Œç¶“æ¥­å‹™äººå“¡ç¢ºèªä¸¦æä¾›æ­£å¼å ±åƒ¹å–®å¾Œç‚ºæº–ã€‚']); 
    excelRows.push([null]);
    
    // --- æ–°å¢æ¬„ä½å¯«å…¥ ---
    excelRows.push(['å®¢æˆ¶åç¨±', client, 'çµ±ä¸€ç·¨è™Ÿ', taxId]);
    excelRows.push(['è¯çµ¡é›»è©±', phone, 'é…é€åœ°å€', address]);
    excelRows.push(['é è¨ˆé€é”æ™‚é–“', `${date} ${time}`]); 
    excelRows.push([null]);
    excelRows.push(['é …ç›®åç¨±ï¼ˆä¸»èœï¼‰èˆ‡å…§å®¹','å–®åƒ¹(æœªç¨…)','æ•¸é‡','å°è¨ˆ(æœªç¨…)']);

    const items = rows.map(tr => ({
      group: tr.dataset.group,
      desc: tr.children[0].textContent,
      price: Number(tr.dataset.price||0),
      qty: Number(tr.dataset.qty||0),
      subtotal: Number(tr.dataset.price||0) * Number(tr.dataset.qty||0)
    }));

    const byGroup = {};
    items.forEach(it => { (byGroup[it.group] ||= []).push(it); });
    Object.keys(byGroup).forEach(g => {
      excelRows.push([`--- ${g} ---`, null, null, null]);
      byGroup[g].forEach(it => excelRows.push([it.desc, it.price, it.qty, it.subtotal]));
    });

    excelRows.push([null]);
    excelRows.push([null,null,'é¤é»å°è¨ˆ (æœªç¨…)', subtotal]);
    
    // âœ¨âœ¨âœ¨ å¦‚æœæœ‰æ—©æ™¨åŠ æˆï¼Œå¯«å…¥ Excel âœ¨âœ¨âœ¨
    if (morningFee > 0) {
        excelRows.push([null,null,'æ—©æ™¨åŠ æˆè²»ç”¨', morningFee]);
    }

    excelRows.push([null,null,'äº¤é€šé‹è²»', shipping]);
    excelRows.push([null,null,'ç‡Ÿæ¥­ç¨… (5%)', tax]);
    excelRows.push([null,null,'ç¸½è¨ˆ (å«ç¨…)', total]);

    const ws = XLSX.utils.aoa_to_sheet(excelRows);
    ws['!cols'] = [{wch:64},{wch:12},{wch:10},{wch:16}];
    // åˆä½µæ¨™é¡Œåˆ—
    ws['!merges'] = [ { s:{r:0,c:0}, e:{r:0,c:3} }, { s:{r:1,c:0}, e:{r:1,c:3} }, { s:{r:2,c:0}, e:{r:2,c:3} } ]; 

    const headerRows = 8; // å› ç‚º header è®Šå¤šäº†ï¼Œé€™è£¡ç¨å¾®èª¿æ•´èµ·å§‹æª¢æŸ¥è¡Œ
    excelRows.forEach((r, i) => {
      if (i >= headerRows) {
        const cellA = `A${i+1}`;
        if (r[1] !== null && r[0] !== null) { 
           if (ws[cellA]) ws[cellA].s = { alignment:{ wrapText:true, vertical:'top' } };
        } else if (r[2] !== null) { 
           const cellLabel = `C${i+1}`;
           if (ws[cellLabel]) ws[cellLabel].s = { font:{bold:true}, alignment:{ horizontal:'right' } };
        }
      }
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'å ±åƒ¹å–®');
    XLSX.writeFile(wb, filename);
  }

  function showModal() {
    const modal = document.getElementById('successModal');
    modal.style.display = 'flex';
    setTimeout(() => { modal.classList.add('active'); }, 10);
  }

  function closeModal() {
    const modal = document.getElementById('successModal');
    modal.classList.remove('active');
    setTimeout(() => { modal.style.display = 'none'; }, 300);
  }

  document.getElementById('successModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      closeModal();
    }
  });

  // ç¶å®šæŒ‰éˆ•äº‹ä»¶ (æ ¸å¿ƒé‚è¼¯ï¼šé»æ“Šè§¸ç™¼ async æµç¨‹)
  $('#btn-download').onclick = handleOrderSubmit;
  
  window.closeModal = closeModal;

  function calculateMinDate() {
    let count = 0;
    let d = new Date();
    d.setDate(d.getDate() + 1); 
    while (count < 5) {
      const day = d.getDay();
      if (day !== 0 && day !== 6) count++;
      if (count < 5) d.setDate(d.getDate() + 1);
    }
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  (function initMeta(){
    const minDateStr = calculateMinDate();
    const dateInput = $('#date');
    dateInput.value = minDateStr; 
    dateInput.min = minDateStr;    
  })();

  selPrice.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  });

  // âœ¨âœ¨âœ¨ ç›£è½å™¨æ›´æ–°ï¼šç•¶æ™‚é–“æ”¹è®Šæ™‚ï¼Œå‘¼å« recalc ä¾†æ›´æ–°é‡‘é¡ âœ¨âœ¨âœ¨
  $('#time').addEventListener('input', function() {
    recalc(); // ç›´æ¥å‘¼å« recalc çµ±ä¸€è™•ç†é‚è¼¯
  });

  window.addEventListener('load', () => {
    console.log('ğŸ“‹ å ±åƒ¹å–®é é¢å·²æº–å‚™å°±ç·’ï¼');
  });
</script>
</body>
</html>
